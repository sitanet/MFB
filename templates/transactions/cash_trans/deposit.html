{% extends "base.html" %}
{% block content %}

{% include 'includes/alerts.html' %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Back Button -->
            <div class="mb-3">
                <a href="javascript:history.back()" class="btn btn-outline-secondary">
                    <i class="fa fa-arrow-left mr-2"></i> Back
                </a>
            </div>
            
            <!-- Header Card -->
            <div class="card border-0 shadow-sm mb-4" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <div class="card-body py-4">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="text-white mb-1"><i class="fas fa-arrow-down me-2"></i>Deposit</h2>
                            <p class="text-white-50 mb-0">Credit funds to customer account</p>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-white text-success px-3 py-2 fs-6">{{ company_date }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Main Form Card -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <form method="POST">
                        {% csrf_token %}
                        
                        {% if messages %}
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            {% for message in messages %}
                            <i class="fas fa-exclamation-triangle me-2"></i>{{ message }}
                            {% endfor %}
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                        {% endif %}
                        
                        {% if form.errors %}
                        <div class="alert alert-danger">{{ form.errors }}</div>
                        {% endif %}

                        <!-- Transaction Info Section -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-3">
                                <label class="form-label fw-semibold text-muted small">BRANCH</label>
                                <input type="text" class="form-control form-control-lg bg-light border-0" value="{{ user.branch.branch_name }}" readonly>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-semibold text-muted small">CUSTOMER BRANCH</label>
                                <input type="text" class="form-control form-control-lg bg-light border-0" value="{{ customer.branch }}" readonly>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">TRX NO</label>
                                <input type="text" class="form-control form-control-lg bg-light border-0" value="{{ data.trx_no }}" readonly>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">SESSION DATE</label>
                                <input type="date" class="form-control form-control-lg bg-light border-0" id="ses_date" name="ses_date" value="{{ company_date }}" readonly>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label fw-semibold text-muted small">TRX DATE</label>
                                <input type="date" class="form-control form-control-lg {% if form.app_date.errors %}is-invalid border-danger{% else %}border-0{% endif %}" id="app_date" name="app_date" value="{{ form.app_date.value }}">
                                {% if form.app_date.errors %}
                                <div class="invalid-feedback">{% for error in form.app_date.errors %}{{ error }}{% endfor %}</div>
                                {% endif %}
                            </div>
                        </div>

                        <hr class="my-4">

                        <!-- Teller Account Section -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-user-tie me-2"></i>Teller Account (Debit)</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold text-muted small">GL NO</label>
                                    <input type="text" class="form-control form-control-lg bg-light border-0" name="gl_no_cashier" value="{{ user.cashier_gl }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold text-muted small">ACCOUNT NO</label>
                                    <input type="text" class="form-control form-control-lg bg-light border-0" name="ac_no_cashier" value="{{ user.cashier_ac }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Customer Account Section -->
                        <div class="mb-4">
                            <h6 class="text-muted mb-3"><i class="fas fa-user me-2"></i>Customer Account (Credit)</h6>
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold text-muted small">GL NO</label>
                                    <input type="text" class="form-control form-control-lg bg-light border-0" name="gl_no" value="{{ customer.gl_no }}" readonly>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-semibold text-muted small">ACCOUNT NO</label>
                                    <input type="text" class="form-control form-control-lg bg-light border-0" name="ac_no" value="{{ customer.ac_no }}" readonly>
                                </div>
                            </div>
                        </div>

                        <!-- Amount and Description -->
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted small">AMOUNT</label>
                                <div class="input-group input-group-lg">
                                    <span class="input-group-text bg-success text-white border-0">&#8358;</span>
                                    <input type="text" class="form-control form-control-lg border-success" placeholder="0.00" id="amount_display" autocomplete="off">
                                    <input type="hidden" name="amount" id="amount_hidden">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-semibold text-muted small">DESCRIPTION</label>
                                <textarea class="form-control form-control-lg" rows="1" name="description" placeholder="Enter transaction description"></textarea>
                            </div>
                        </div>

                        <!-- Balance Cards -->
                        <div class="row g-4 mb-4">
                            <!-- Teller Balance Card -->
                            <div class="col-md-6">
                                <div class="card border-0 h-100" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                    <div class="card-body text-white">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h6 class="text-white-50 mb-1">DEBIT FROM</h6>
                                                <h5 class="mb-0">{{ customers.first_name }}</h5>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-light" onclick="showCashierHistory()" title="Cashier History">
                                                <i class="fas fa-history text-danger"></i>
                                            </button>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <small class="text-white-50">Available Balance</small>
                                                <h4 class="mb-0">&#8358;{{ sum_of_amount_cash|default:"0.00" }}</h4>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-white-50">Last Trx Amount</small>
                                                <h5 class="mb-0">&#8358;{{ data.amount|default:"0.00" }}</h5>
                                            </div>
                                        </div>
                                        <hr class="my-2 border-light opacity-25">
                                        <small class="text-white-50">Last Trx ID: {{ data.trx_no|default:"-" }}</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Customer Balance Card -->
                            <div class="col-md-6">
                                <div class="card border-0 h-100" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                    <div class="card-body text-white">
                                        <div class="d-flex justify-content-between align-items-start mb-3">
                                            <div>
                                                <h6 class="text-white-50 mb-1">CREDIT TO</h6>
                                                <h5 class="mb-0">{{ customer.first_name }} {{ customer.middle_name }} {{ customer.last_name }}</h5>
                                            </div>
                                            <button type="button" class="btn btn-sm btn-light" onclick="showTransactionHistory()" title="Customer History">
                                                <i class="fas fa-history text-success"></i>
                                            </button>
                                        </div>
                                        <div class="row g-2">
                                            <div class="col-6">
                                                <small class="text-white-50">Current Balance</small>
                                                <h4 class="mb-0">&#8358;{{ sum_of_amount_cust|default:"0.00" }}</h4>
                                            </div>
                                            <div class="col-6">
                                                <small class="text-white-50">Last Trx Amount</small>
                                                <h5 class="mb-0">&#8358;{{ last_transaction.amount|default:"0.00" }}</h5>
                                            </div>
                                        </div>
                                        <hr class="my-2 border-light opacity-25">
                                        <small class="text-white-50">Last Trx: {{ last_transaction.trx_no|default:"-" }} | {{ last_transaction.sys_date|date:"d-m-Y"|default:"-" }}</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="d-flex justify-content-between align-items-center pt-3 border-top">
                            <div class="btn-group">
                                <button type="button" class="btn btn-primary btn-lg" onclick="showTransactionHistory()" title="Transaction History">
                                    <i class="fas fa-history"></i>
                                </button>
                                <button type="button" class="btn btn-info btn-lg" onclick="showCustomerImage()" title="View Photo">
                                    <i class="fas fa-image"></i>
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg" onclick="showCustomerImage2()" title="View Signature">
                                    <i class="fas fa-signature"></i>
                                </button>
                            </div>
                            <button type="submit" class="btn btn-success btn-lg px-5" onclick="return validateForm()">
                                <i class="fas fa-check-circle me-2"></i>Process Deposit
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Modal -->
<div class="modal fade" id="customerImageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-primary text-white">
                <h5 class="modal-title"><i class="fas fa-user-circle me-2"></i>Customer Photo</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeModal()"></button>
            </div>
            <div class="modal-body p-0">
                <img src="{{ customer.photo.url }}" alt="Customer Photo" class="img-fluid w-100">
            </div>
        </div>
    </div>
</div>

<!-- Signature Modal -->
<div class="modal fade" id="customerImageModal2" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0 bg-secondary text-white">
                <h5 class="modal-title"><i class="fas fa-signature me-2"></i>Customer Signature</h5>
                <button type="button" class="btn-close btn-close-white" onclick="closeModal2()"></button>
            </div>
            <div class="modal-body p-0">
                <img src="{{ customer.sign.url }}" alt="Customer Signature" class="img-fluid w-100">
            </div>
        </div>
    </div>
</div>

<!-- Customer Transaction History Modal -->
<div class="modal fade" id="transactionHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                <div class="text-white">
                    <h5 class="modal-title mb-0"><i class="fas fa-history me-2"></i>Customer Transaction History</h5>
                    <small>{{ customer.first_name }} {{ customer.last_name }} | {{ customer.gl_no }}-{{ customer.ac_no }}</small>
                </div>
                <button type="button" class="btn-close btn-close-white" onclick="closeHistoryModal()"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0">Date</th>
                                <th class="border-0">Trx No</th>
                                <th class="border-0">Description</th>
                                <th class="border-0">Type</th>
                                <th class="border-0 text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trx in last_transactions %}
                            <tr>
                                <td><small>{{ trx.sys_date|date:"d-m-Y H:i" }}</small></td>
                                <td><code>{{ trx.trx_no }}</code></td>
                                <td>{{ trx.description|truncatechars:30 }}</td>
                                <td>
                                    {% if trx.type == 'C' %}
                                    <span class="badge bg-success">Credit</span>
                                    {% else %}
                                    <span class="badge bg-danger">Debit</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold {% if trx.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                                    &#8358;{{ trx.amount|floatformat:2 }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p class="mb-0">No transactions found</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Cashier Transaction History Modal -->
<div class="modal fade" id="cashierHistoryModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content border-0 shadow">
            <div class="modal-header border-0" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                <div class="text-white">
                    <h5 class="modal-title mb-0"><i class="fas fa-history me-2"></i>Cashier Transaction History</h5>
                    <small>{{ customers.first_name }} {{ customers.last_name }} | {{ customers.gl_no }}-{{ customers.ac_no }}</small>
                </div>
                <button type="button" class="btn-close btn-close-white" onclick="closeCashierHistoryModal()"></button>
            </div>
            <div class="modal-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0">Date</th>
                                <th class="border-0">Trx No</th>
                                <th class="border-0">Description</th>
                                <th class="border-0">Type</th>
                                <th class="border-0 text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for trx in cashier_transactions %}
                            <tr>
                                <td><small>{{ trx.sys_date|date:"d-m-Y H:i" }}</small></td>
                                <td><code>{{ trx.trx_no }}</code></td>
                                <td>{{ trx.description|truncatechars:30 }}</td>
                                <td>
                                    {% if trx.type == 'C' %}
                                    <span class="badge bg-success">Credit</span>
                                    {% else %}
                                    <span class="badge bg-danger">Debit</span>
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold {% if trx.amount < 0 %}text-danger{% else %}text-success{% endif %}">
                                    &#8358;{{ trx.amount|floatformat:2 }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3"></i>
                                    <p class="mb-0">No transactions found</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    function showCustomerImage() {
        document.getElementById("customerImageModal").classList.add('show');
        document.getElementById("customerImageModal").style.display = "block";
        document.body.classList.add('modal-open');
    }
    function showCustomerImage2() {
        document.getElementById("customerImageModal2").classList.add('show');
        document.getElementById("customerImageModal2").style.display = "block";
        document.body.classList.add('modal-open');
    }
    function showTransactionHistory() {
        document.getElementById("transactionHistoryModal").classList.add('show');
        document.getElementById("transactionHistoryModal").style.display = "block";
        document.body.classList.add('modal-open');
    }
    function closeModal() {
        document.getElementById("customerImageModal").classList.remove('show');
        document.getElementById("customerImageModal").style.display = "none";
        document.body.classList.remove('modal-open');
    }
    function closeModal2() {
        document.getElementById("customerImageModal2").classList.remove('show');
        document.getElementById("customerImageModal2").style.display = "none";
        document.body.classList.remove('modal-open');
    }
    function closeHistoryModal() {
        document.getElementById("transactionHistoryModal").classList.remove('show');
        document.getElementById("transactionHistoryModal").style.display = "none";
        document.body.classList.remove('modal-open');
    }
    function showCashierHistory() {
        document.getElementById("cashierHistoryModal").classList.add('show');
        document.getElementById("cashierHistoryModal").style.display = "block";
        document.body.classList.add('modal-open');
    }
    function closeCashierHistoryModal() {
        document.getElementById("cashierHistoryModal").classList.remove('show');
        document.getElementById("cashierHistoryModal").style.display = "none";
        document.body.classList.remove('modal-open');
    }
    
    window.onclick = function(event) {
        var modals = ['customerImageModal', 'customerImageModal2', 'transactionHistoryModal', 'cashierHistoryModal'];
        modals.forEach(function(id) {
            var modal = document.getElementById(id);
            if (event.target == modal) {
                modal.classList.remove('show');
                modal.style.display = "none";
                document.body.classList.remove('modal-open');
            }
        });
    }

    document.addEventListener('DOMContentLoaded', function() {
        var sessionDateInput = document.getElementById('ses_date');
        var companyDate = '{{ company_date }}';
        var appDateInput = document.getElementById('app_date');
        if (appDateInput) {
            appDateInput.addEventListener('change', function() {
                var selectedDate = new Date(appDateInput.value);
                var companyDateObj = new Date(companyDate);
                if (selectedDate > companyDateObj) {
                    alert('Please select a date not greater than the session date.');
                    appDateInput.value = companyDate;
                }
            });
        }

        // Amount formatting with commas and decimals
        var amountDisplay = document.getElementById('amount_display');
        var amountHidden = document.getElementById('amount_hidden');

        function formatNumber(num) {
            if (!num) return '';
            var parts = num.toString().split('.');
            parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            return parts.join('.');
        }

        function unformatNumber(str) {
            return str.replace(/,/g, '');
        }

        amountDisplay.addEventListener('input', function(e) {
            var cursorPos = this.selectionStart;
            var oldLength = this.value.length;
            var rawValue = unformatNumber(this.value).replace(/[^0-9.]/g, '');
            
            // Ensure only one decimal point
            var parts = rawValue.split('.');
            if (parts.length > 2) {
                rawValue = parts[0] + '.' + parts.slice(1).join('');
            }
            
            // Limit decimal places to 2
            if (parts.length === 2 && parts[1].length > 2) {
                rawValue = parts[0] + '.' + parts[1].substring(0, 2);
            }

            amountHidden.value = rawValue;
            this.value = formatNumber(rawValue);
            
            // Adjust cursor position
            var newLength = this.value.length;
            cursorPos = cursorPos + (newLength - oldLength);
            this.setSelectionRange(cursorPos, cursorPos);
        });

        amountDisplay.addEventListener('blur', function() {
            var rawValue = unformatNumber(this.value);
            if (rawValue && !isNaN(rawValue)) {
                var num = parseFloat(rawValue).toFixed(2);
                amountHidden.value = num;
                this.value = formatNumber(num);
            }
        });
    });

    function validateForm() {
        var appDate = document.getElementById('app_date');
        var amount = document.getElementById('amount_hidden');
        var amountDisplay = document.getElementById('amount_display');
        var description = document.querySelector('textarea[name="description"]');
        var errors = [];

        // Clear previous errors
        clearError(appDate);
        clearError(amountDisplay);
        if (description) clearError(description);

        // Validate TRX Date
        if (!appDate.value) {
            showError(appDate, 'Transaction date is required');
            errors.push('Transaction date is required');
        }

        // Validate Amount
        if (!amount.value || parseFloat(amount.value) <= 0) {
            showError(amountDisplay, 'Please enter a valid amount');
            errors.push('Please enter a valid amount');
        }

        // Validate Description
        if (description && !description.value.trim()) {
            showError(description, 'Description is required');
            errors.push('Description is required');
        }

        // Show alert if there are errors
        if (errors.length > 0) {
            alert('Please fix the following errors:\n\n- ' + errors.join('\n- '));
            return false;
        }

        return true;
    }

    function showError(element, message) {
        element.classList.add('is-invalid', 'border-danger');
        var errorDiv = element.parentElement.querySelector('.invalid-feedback');
        if (!errorDiv) {
            errorDiv = document.createElement('div');
            errorDiv.className = 'invalid-feedback';
            element.parentElement.appendChild(errorDiv);
        }
        errorDiv.textContent = message;
        errorDiv.style.display = 'block';
    }

    function clearError(element) {
        element.classList.remove('is-invalid', 'border-danger');
        var errorDiv = element.parentElement.querySelector('.invalid-feedback');
        if (errorDiv) {
            errorDiv.style.display = 'none';
        }
    }
</script>

<style>
    .modal.show { background-color: rgba(0,0,0,0.5); }
    .form-control:focus { box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25); border-color: #28a745; }
    .card { transition: transform 0.2s; }
    .btn-group .btn { border-radius: 0.5rem !important; margin-right: 0.25rem; }
</style>

{% endblock %}
