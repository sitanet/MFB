{% extends "base.html" %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="page_title">
                <h2>Choose Withdrawal</h2>
            </div>
        </div>
        
        <div class="container deposit p-5 shadow-lg rounded rounded-5">
            <!-- Quick Access Cards -->
            <div class="row mt-3">
                {% for quick_action in quick_actions %}
                <div class="col-md-3 mb-3">
                    <div class="account_setting py-5 fs-1 bg-white shadow-lg rounded rounded-5">
                        <div class="couter_icon col-md-3">
                            <i class="fa {{ quick_action.icon }} yellow_color"></i>
                        </div>
                        <a href="{% url quick_action.url %}" class="text-center">
                            <h5 class="my-2">{{ quick_action.title }}</h5>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Messages -->
            {% if messages %}
            <div class="row">
                <div class="col-md-12">
                    <ul class="messages">
                        {% for message in messages %}
                        <li style="font-size: 20px; color: brown; font-weight: bold; margin-left: 30%;" 
                            {% if message.tags %} class="{{ message.tags }}"{% endif %}>
                            {{ message }}
                        </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
            {% endif %}

            <!-- Search and Table -->
            <div class="row mt-3 table-row1">
                <div class="col-md-12 justify-content-center text-center m-auto">
                    <div class="input-group mb-3">
                        <input type="text" class="form-control form-control-lg bg-white border" 
                               placeholder="Search by name, account or GL..." id="searchInput">
                        <div class="">
                            <button class="btn btn-success py-3" type="button" onclick="searchTable()">
                                Search
                            </button>
                        </div>
                    </div>

                    <!-- Customer Table -->
                    <div class="table-responsive">
                        <table class="table table-hover" id="withdrawalTable">
                            <thead class="thead-dark">
                                <tr>
                                    <th>Passport</th>
                                    <th>Customer Name</th>
                                    <th>GL No.</th>
                                    <th>Account No.</th>
                                    <th>Balance</th>
                                    <th>Branch</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in customer_data %}
                                <tr>
                                    <td>
                                        {% if item.customer.passport %}
                                        <img src="{{ item.customer.passport.url }}" class="rounded-circle" style="width: 50px; height: 50px;" alt="Passport">
                                        {% else %}
                                        <img src="/static/images/default_user.png" class="rounded-circle" style="width: 50px; height: 50px;" alt="Default">
                                        {% endif %}
                                    </td>
                                    <td>{{ item.customer.first_name }} {{ item.customer.last_name }}</td>
                                    <td>{{ item.customer.gl_no }}</td>
                                    <td>{{ item.customer.ac_no }}</td>
                                    <td>N{{ item.formatted_balance }}</td>
                                    <td>{{ item.customer.branch.branch_name }}</td>
                                    <td>
                                        {% if item.can_withdraw %}
                                        <a href="{% url 'withdraw' item.customer.id %}" 
                                           class="btn shadow-sm" 
                                           style="background-color: #FE632A; font-weight: bold; color: white;">
                                            Withdraw
                                        </a>
                                        {% else %}
                                        <span class="text-muted">No funds</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% empty %}
                                <tr>
                                    <td colspan="7" class="text-center">No customers found</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    {% if customer_data.paginator.num_pages > 1 %}
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            {% if customer_data.has_previous %}
                            <li class="page-item">
                                <a class="page-link" href="?page=1" aria-label="First">
                                    <span aria-hidden="true">&laquo;&laquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ customer_data.previous_page_number }}" aria-label="Previous">
                                    <span aria-hidden="true">&laquo;</span>
                                </a>
                            </li>
                            {% endif %}
                            
                            {% for num in customer_data.paginator.page_range %}
                            {% if customer_data.number == num %}
                            <li class="page-item active"><a class="page-link" href="#">{{ num }}</a></li>
                            {% elif num > customer_data.number|add:'-3' and num < customer_data.number|add:'3' %}
                            <li class="page-item"><a class="page-link" href="?page={{ num }}">{{ num }}</a></li>
                            {% endif %}
                            {% endfor %}
                            
                            {% if customer_data.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="?page={{ customer_data.next_page_number }}" aria-label="Next">
                                    <span aria-hidden="true">&raquo;</span>
                                </a>
                            </li>
                            <li class="page-item">
                                <a class="page-link" href="?page={{ customer_data.paginator.num_pages }}" aria-label="Last">
                                    <span aria-hidden="true">&raquo;&raquo;</span>
                                </a>
                            </li>
                            {% endif %}
                        </ul>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function searchTable() {
    const input = document.getElementById('searchInput');
    const filter = input.value.toUpperCase();
    const table = document.getElementById('withdrawalTable');
    const tr = table.getElementsByTagName('tr');

    for (let i = 1; i < tr.length; i++) {
        let found = false;
        const td = tr[i].getElementsByTagName('td');
        
        for (let j = 0; j < td.length - 1; j++) { // Skip action column
            if (td[j]) {
                const txtValue = td[j].textContent || td[j].innerText;
                if (txtValue.toUpperCase().indexOf(filter) > -1) {
                    found = true;
                    break;
                }
            }
        }
        
        tr[i].style.display = found ? '' : 'none';
    }
}

// Add event listener for Enter key
document.getElementById('searchInput').addEventListener('keyup', function(event) {
    if (event.key === 'Enter') {
        searchTable();
    }
});
</script>

{% endblock %}