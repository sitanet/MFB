{% extends "base.html" %}
{% load humanize %}

{% block content %}
<style>
:root {
    /* Orange & Green Theme - matching project colors */
    --primary-orange: #f97316;
    --primary-orange-dark: #ea580c;
    --primary-green: #16a34a;
    --primary-green-dark: #15803d;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --light: #f8fafc;
    --dark: #0f172a;
    --gray-100: #f1f5f9;
    --gray-200: #e2e8f0;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --gray-500: #64748b;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.stats-container {
    background: linear-gradient(135deg, #f0fdf4 0%, #fff7ed 100%);
    min-height: 100vh;
    padding: 1.5rem 0;
}

/* Header Section */
.stats-header {
    background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-green) 100%);
    border-radius: 20px;
    padding: 3rem 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    color: white;
    position: relative;
    overflow: hidden;
}

.stats-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
    transform: rotate(30deg);
}

.stats-header h1 {
    font-size: 2.5rem;
    font-weight: 700;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 2;
}

.stats-header p {
    font-size: 1.125rem;
    opacity: 0.9;
    position: relative;
    z-index: 2;
    margin-bottom: 1rem;
}

.stats-header .header-icon {
    position: absolute;
    top: 2rem;
    right: 2rem;
    font-size: 4rem;
    opacity: 0.2;
    z-index: 1;
}

.date-range-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.75rem 1.5rem;
    border-radius: 50px;
    font-weight: 600;
    display: inline-block;
    position: relative;
    z-index: 2;
}

/* Statistics Cards */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 1.5rem;
    margin-bottom: 3rem;
}

.stat-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stat-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--card-hover-shadow);
}

.stat-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--card-accent);
    border-radius: 20px 20px 0 0;
}

.stat-card.card-blue { --card-accent: var(--info); }
.stat-card.card-green { --card-accent: var(--success); }
.stat-card.card-orange { --card-accent: var(--warning); }
.stat-card.card-red { --card-accent: var(--danger); }
.stat-card.card-purple { --card-accent: #8b5cf6; }
.stat-card.card-teal { --card-accent: #14b8a6; }

.stat-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 1.5rem;
}

.stat-icon {
    width: 60px;
    height: 60px;
    border-radius: 16px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    color: white;
    background: var(--card-accent);
}

.stat-value {
    font-size: 2.5rem;
    font-weight: 700;
    color: var(--dark);
    margin-bottom: 0.5rem;
    line-height: 1;
}

.stat-label {
    color: var(--gray-400);
    font-weight: 500;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.stat-trend {
    font-size: 0.8rem;
    padding: 0.25rem 0.5rem;
    border-radius: 50px;
    font-weight: 600;
}

.trend-up { background: #dcfce7; color: #16a34a; }
.trend-down { background: #fee2e2; color: #dc2626; }
.trend-stable { background: #f1f5f9; color: #64748b; }

/* Enhanced Tables */
.data-card {
    background: white;
    border-radius: 20px;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
    overflow: hidden;
    transition: all 0.3s ease;
}

.data-card:hover {
    box-shadow: var(--card-hover-shadow);
}

.data-card-header {
    background: linear-gradient(135deg, var(--gray-100) 0%, white 100%);
    padding: 2rem;
    border-bottom: 2px solid var(--gray-100);
    position: relative;
}

.data-card-header::before {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-orange), var(--primary-green));
}

.data-card-header h3 {
    margin: 0;
    color: var(--dark);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 1rem;
    font-size: 1.5rem;
}

.data-card-body {
    padding: 0;
}

.data-icon {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
    color: white;
    background: linear-gradient(135deg, var(--section-color), var(--section-color-dark));
}

.actions-section { --section-color: var(--info); --section-color-dark: #2563eb; }
.users-section { --section-color: var(--success); --section-color-dark: var(--primary-green-dark); }
.failures-section { --section-color: var(--danger); --section-color-dark: #dc2626; }
.category-section { --section-color: var(--primary-orange); --section-color-dark: var(--primary-orange-dark); }

/* Modern Table Styling */
.modern-table {
    width: 100%;
    margin: 0;
    background: white;
}

.modern-table thead {
    background: var(--light);
}

.modern-table thead th {
    padding: 1.5rem 2rem;
    font-weight: 600;
    color: var(--gray-500);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    border: none;
}

.modern-table tbody td {
    padding: 1.5rem 2rem;
    border-top: 1px solid var(--gray-100);
    vertical-align: middle;
}

.modern-table tbody tr {
    transition: all 0.2s ease;
}

.modern-table tbody tr:hover {
    background: var(--light);
}

/* Badge Styling */
.badge-modern {
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.8rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.badge-primary { background: var(--info); color: white; }
.badge-secondary { background: var(--gray-300); color: var(--dark); }
.badge-success { background: var(--success); color: white; }
.badge-danger { background: var(--danger); color: white; }
.badge-warning { background: var(--warning); color: white; }

/* Progress Bars */
.progress-modern {
    height: 8px;
    background: var(--gray-100);
    border-radius: 50px;
    overflow: hidden;
    margin: 0.5rem 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-orange), var(--primary-green));
    border-radius: 50px;
    transition: width 0.8s ease;
}

/* User Cards */
.user-card {
    display: flex;
    align-items: center;
    gap: 1rem;
    padding: 1rem;
    margin-bottom: 0.5rem;
    background: var(--light);
    border-radius: 12px;
    transition: all 0.2s ease;
}

.user-card:hover {
    background: var(--gray-200);
    transform: translateX(4px);
}

.user-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-green));
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 600;
    font-size: 0.875rem;
}

.user-info {
    flex: 1;
}

.user-name {
    font-weight: 600;
    color: var(--dark);
    margin: 0;
}

.user-email {
    font-size: 0.8rem;
    color: var(--gray-400);
    margin: 0;
}

.user-count {
    background: var(--success);
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.875rem;
}

/* Risk Level Indicators */
.risk-indicator {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1rem;
    border-radius: 12px;
    font-weight: 600;
}

.risk-high { background: #fee2e2; color: #dc2626; }
.risk-medium { background: #fef3c7; color: #d97706; }
.risk-low { background: #dbeafe; color: #2563eb; }

/* Quick Actions */
.action-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
    margin-bottom: 2rem;
}

.action-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--card-shadow);
    transition: all 0.3s ease;
    text-decoration: none;
    color: inherit;
    position: relative;
    overflow: hidden;
}

.action-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--card-hover-shadow);
    text-decoration: none;
    color: inherit;
}

.action-card::before {
    content: "";
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--primary-orange), var(--primary-green));
}

.action-header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 0.5rem;
}

.action-icon {
    width: 40px;
    height: 40px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1rem;
    color: white;
    background: linear-gradient(135deg, var(--primary-orange), var(--primary-green));
}

.action-title {
    font-weight: 600;
    color: var(--dark);
    margin: 0;
    font-size: 0.9rem;
}

/* Empty States */
.empty-state {
    text-align: center;
    padding: 3rem;
    color: var(--gray-400);
}

.empty-state-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
}

/* Chart Placeholders */
.chart-placeholder {
    height: 300px;
    background: linear-gradient(135deg, var(--gray-100), var(--light));
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: var(--gray-400);
    font-size: 1.2rem;
    margin: 1rem 0;
}

/* Responsive Design */
@media (max-width: 768px) {
    .stats-header {
        padding: 2rem 1.5rem;
        text-align: center;
    }
    
    .stats-header h1 {
        font-size: 2rem;
    }
    
    .stats-header .header-icon {
        display: none;
    }
    
    .stats-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .stat-card {
        padding: 1.5rem;
    }
    
    .data-card-header {
        padding: 1.5rem;
    }
    
    .modern-table thead th,
    .modern-table tbody td {
        padding: 1rem;
    }
    
    .action-grid {
        grid-template-columns: 1fr;
    }
}

/* Animation Classes */
.fade-in {
    animation: fadeIn 0.6s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

.slide-up {
    animation: slideUp 0.6s ease-out;
}

@keyframes slideUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
}

.counter-animation {
    animation: countUp 1.5s ease-out forwards;
}

@keyframes countUp {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
}
</style>

<div class="stats-container">
    <div class="container-fluid">
        
        <!-- Header -->
        <div class="stats-header fade-in">
            <div class="header-icon">
                <i class="fas fa-chart-bar"></i>
            </div>
            <h1><i class="fas fa-analytics me-3"></i>Audit Trail Statistics & Reports</h1>
            <p>Comprehensive analytics and insights into system usage, security patterns, and compliance metrics for informed decision making.</p>
            <div class="date-range-badge">
                <i class="fas fa-calendar-alt me-2"></i>{{ start_date }} to {{ end_date }}
            </div>
        </div>

        <!-- Category Overview Cards -->
        <div class="stats-grid slide-up">
            {% for category in category_breakdown %}
            <div class="stat-card card-{% cycle 'blue' 'green' 'orange' 'red' 'purple' 'teal' %}">
                <div class="stat-header">
                    <div class="stat-icon">
                        {% if category.category == 'AUTHENTICATION' %}
                            <i class="fas fa-shield-alt"></i>
                        {% elif category.category == 'TRANSACTION' %}
                            <i class="fas fa-exchange-alt"></i>
                        {% elif category.category == 'ADMIN' %}
                            <i class="fas fa-user-shield"></i>
                        {% elif category.category == 'CUSTOMER' %}
                            <i class="fas fa-users"></i>
                        {% elif category.category == 'ACCOUNT' %}
                            <i class="fas fa-university"></i>
                        {% else %}
                            <i class="fas fa-chart-pie"></i>
                        {% endif %}
                    </div>
                    <div class="stat-trend trend-stable">
                        <i class="fas fa-minus me-1"></i>Stable
                    </div>
                </div>
                <div class="stat-value counter-animation">{{ category.count|intcomma }}</div>
                <div class="stat-label">{{ category.category|default:"Unknown Category" }}</div>
                <div class="progress-modern">
                    <div class="progress-bar" style="width: {% if category_breakdown.0.count > 0 %}{% widthratio category.count category_breakdown.0.count 100 %}{% else %}0{% endif %}%"></div>
                </div>
            </div>
            {% empty %}
            <div class="stat-card card-blue">
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-pie"></i>
                    </div>
                    <p>No category data available for this period</p>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="row">
            <!-- Actions Breakdown -->
            <div class="col-lg-6">
                <div class="data-card actions-section slide-up" style="animation-delay: 0.1s;">
                    <div class="data-card-header">
                        <h3>
                            <div class="data-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            Actions Breakdown
                        </h3>
                    </div>
                    <div class="data-card-body">
                        {% if action_breakdown %}
                        <table class="modern-table">
                            <thead>
                                <tr>
                                    <th>Action</th>
                                    <th>Count</th>
                                    <th>Distribution</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for action in action_breakdown %}
                                <tr>
                                    <td>
                                        <span class="badge-modern badge-primary">
                                            <i class="fas fa-bolt me-1"></i>{{ action.action|default:"Unknown" }}
                                        </span>
                                    </td>
                                    <td>
                                        <strong>{{ action.count|intcomma }}</strong>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center gap-2">
                                            <div class="progress-modern flex-grow-1">
                                                <div class="progress-bar" style="width: {% if action_breakdown.0.count > 0 %}{% widthratio action.count action_breakdown.0.count 100 %}{% else %}0{% endif %}%"></div>
                                            </div>
                                            <span class="text-muted small">
                                                {% if action_breakdown.0.count > 0 %}
                                                    {% widthratio action.count action_breakdown.0.count 100 %}%
                                                {% else %}
                                                    0%
                                                {% endif %}
                                            </span>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-bolt"></i>
                            </div>
                            <h4>No Action Data</h4>
                            <p>No action data available for this period</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Top Users -->
            <div class="col-lg-6">
                <div class="data-card users-section slide-up" style="animation-delay: 0.2s;">
                    <div class="data-card-header">
                        <h3>
                            <div class="data-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            Most Active Users
                        </h3>
                    </div>
                    <div class="data-card-body">
                        {% if user_activity %}
                        <div class="p-3">
                            {% for user in user_activity|slice:":10" %}
                            <div class="user-card">
                                <div class="user-avatar">
                                    {{ user.name|default:"U"|first|upper }}
                                </div>
                                <div class="user-info">
                                    <div class="user-name">{{ user.name|default:"Unknown User" }}</div>
                                    <div class="user-email">{{ user.email|default:"No email" }}</div>
                                </div>
                                <div class="user-count">
                                    {{ user.activity_count|intcomma }}
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <h4>No User Data</h4>
                            <p>No user activity data available</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Failed Attempts Analysis -->
        <div class="data-card failures-section slide-up" style="animation-delay: 0.3s;">
            <div class="data-card-header">
                <h3>
                    <div class="data-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    Security Analysis - Failed Attempts
                </h3>
            </div>
            <div class="data-card-body">
                {% if failed_attempts %}
                <table class="modern-table">
                    <thead>
                        <tr>
                            <th>Action Type</th>
                            <th>Category</th>
                            <th>Failed Count</th>
                            <th>Risk Assessment</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for failure in failed_attempts %}
                        <tr>
                            <td>
                                <span class="badge-modern badge-danger">
                                    <i class="fas fa-times me-1"></i>{{ failure.action|default:"Unknown" }}
                                </span>
                            </td>
                            <td>
                                <span class="badge-modern badge-secondary">
                                    {{ failure.category|default:"Unknown" }}
                                </span>
                            </td>
                            <td>
                                <div class="d-flex align-items-center gap-2">
                                    <strong class="text-danger">{{ failure.count|intcomma }}</strong>
                                    {% if failure.count > 20 %}
                                        <i class="fas fa-arrow-up text-danger" title="High volume"></i>
                                    {% elif failure.count > 10 %}
                                        <i class="fas fa-arrow-right text-warning" title="Moderate volume"></i>
                                    {% else %}
                                        <i class="fas fa-arrow-down text-success" title="Low volume"></i>
                                    {% endif %}
                                </div>
                            </td>
                            <td>
                                {% if failure.count > 10 %}
                                    <div class="risk-indicator risk-high">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        High Risk - Investigate Immediately
                                    </div>
                                {% elif failure.count > 5 %}
                                    <div class="risk-indicator risk-medium">
                                        <i class="fas fa-exclamation"></i>
                                        Medium Risk - Monitor Closely
                                    </div>
                                {% else %}
                                    <div class="risk-indicator risk-low">
                                        <i class="fas fa-info-circle"></i>
                                        Low Risk - Normal Activity
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-shield-check"></i>
                    </div>
                    <h4>Excellent Security!</h4>
                    <p>No failed attempts recorded for this period. Your system security is performing well.</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Performance Metrics (Placeholder for future charts) -->
        <div class="row">
            <div class="col-lg-6">
                <div class="data-card slide-up" style="animation-delay: 0.4s;">
                    <div class="data-card-header">
                        <h3>
                            <div class="data-icon">
                                <i class="fas fa-chart-line"></i>
                            </div>
                            Activity Timeline
                        </h3>
                    </div>
                    <div class="data-card-body">
                        <div class="chart-placeholder">
                            <div class="text-center">
                                <i class="fas fa-chart-line fa-3x mb-3"></i>
                                <p>Activity timeline chart will be displayed here</p>
                                <small class="text-muted">Chart integration coming soon</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-6">
                <div class="data-card slide-up" style="animation-delay: 0.5s;">
                    <div class="data-card-header">
                        <h3>
                            <div class="data-icon">
                                <i class="fas fa-chart-pie"></i>
                            </div>
                            Category Distribution
                        </h3>
                    </div>
                    <div class="data-card-body">
                        <div class="chart-placeholder">
                            <div class="text-center">
                                <i class="fas fa-chart-pie fa-3x mb-3"></i>
                                <p>Category distribution pie chart will be displayed here</p>
                                <small class="text-muted">Chart integration coming soon</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="data-card slide-up" style="animation-delay: 0.6s;">
            <div class="data-card-header">
                <h3>
                    <div class="data-icon">
                        <i class="fas fa-rocket"></i>
                    </div>
                    Quick Actions
                </h3>
            </div>
            <div class="data-card-body">
                <div class="action-grid p-3">
                    <a href="{% url 'audit_trail:list' %}" class="action-card">
                        <div class="action-header">
                            <div class="action-icon">
                                <i class="fas fa-list"></i>
                            </div>
                            <div class="action-title">View All Logs</div>
                        </div>
                        <p class="text-muted mb-0 small">Browse complete audit trail</p>
                    </a>

                    <a href="{% url 'audit_trail:export_csv' %}" class="action-card">
                        <div class="action-header">
                            <div class="action-icon">
                                <i class="fas fa-download"></i>
                            </div>
                            <div class="action-title">Export Data</div>
                        </div>
                        <p class="text-muted mb-0 small">Download CSV reports</p>
                    </a>

                    <a href="{% url 'audit_trail:configuration' %}" class="action-card">
                        <div class="action-header">
                            <div class="action-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            <div class="action-title">Configuration</div>
                        </div>
                        <p class="text-muted mb-0 small">Adjust tracking settings</p>
                    </a>

                    <a href="{% url 'audit_trail:alerts' %}" class="action-card">
                        <div class="action-header">
                            <div class="action-icon">
                                <i class="fas fa-bell"></i>
                            </div>
                            <div class="action-title">Security Alerts</div>
                        </div>
                        <p class="text-muted mb-0 small">Monitor security events</p>
                    </a>

                    <a href="{% url 'audit_trail:dashboard' %}" class="action-card">
                        <div class="action-header">
                            <div class="action-icon">
                                <i class="fas fa-home"></i>
                            </div>
                            <div class="action-title">Dashboard</div>
                        </div>
                        <p class="text-muted mb-0 small">Return to main dashboard</p>
                    </a>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- JavaScript for Enhanced Interactions -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Animate progress bars
    animateProgressBars();
    
    // Animate counters
    animateCounters();
    
    // Add interactive features
    addInteractiveFeatures();
    
    // Initialize tooltips
    initializeTooltips();
});

function animateProgressBars() {
    const progressBars = document.querySelectorAll('.progress-bar');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const bar = entry.target;
                const targetWidth = bar.style.width;
                bar.style.width = '0%';
                
                setTimeout(() => {
                    bar.style.width = targetWidth;
                }, 100);
                
                observer.unobserve(bar);
            }
        });
    });
    
    progressBars.forEach(bar => observer.observe(bar));
}

function animateCounters() {
    const counters = document.querySelectorAll('.stat-value');
    
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const counter = entry.target;
                const target = parseInt(counter.textContent.replace(/,/g, ''));
                
                if (!isNaN(target)) {
                    animateValue(counter, 0, target, 1500);
                }
                
                observer.unobserve(counter);
            }
        });
    });
    
    counters.forEach(counter => observer.observe(counter));
}

function animateValue(element, start, end, duration) {
    let startTimestamp = null;
    
    const step = (timestamp) => {
        if (!startTimestamp) startTimestamp = timestamp;
        const progress = Math.min((timestamp - startTimestamp) / duration, 1);
        const current = Math.floor(progress * (end - start) + start);
        
        element.textContent = current.toLocaleString();
        
        if (progress < 1) {
            window.requestAnimationFrame(step);
        }
    };
    
    window.requestAnimationFrame(step);
}

function addInteractiveFeatures() {
    // Add hover effects to user cards
    const userCards = document.querySelectorAll('.user-card');
    userCards.forEach(card => {
        card.addEventListener('mouseenter', function() {
            this.style.transform = 'translateX(8px) scale(1.02)';
        });
        
        card.addEventListener('mouseleave', function() {
            this.style.transform = 'translateX(4px) scale(1)';
        });
    });
    
    // Add click handlers for risk indicators
    const riskIndicators = document.querySelectorAll('.risk-indicator');
    riskIndicators.forEach(indicator => {
        if (indicator.classList.contains('risk-high')) {
            indicator.style.cursor = 'pointer';
            indicator.title = 'Click for recommendations';
            indicator.addEventListener('click', function() {
                showRiskRecommendations();
            });
        }
    });
    
    // Add export functionality
    const exportLinks = document.querySelectorAll('a[href*="export"]');
    exportLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            showExportProgress();
        });
    });
}

function initializeTooltips() {
    // Add tooltips to various elements
    const tooltipElements = [
        { selector: '.stat-trend', content: 'Trend analysis compared to previous period' },
        { selector: '.progress-bar', content: 'Relative distribution percentage' },
        { selector: '.user-avatar', content: 'Click to view user details' }
    ];
    
    tooltipElements.forEach(({ selector, content }) => {
        document.querySelectorAll(selector).forEach(element => {
            if (!element.title) {
                element.title = content;
            }
        });
    });
}

function showRiskRecommendations() {
    // Create and show recommendations modal/toast
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #fee2e2;
        color: #dc2626;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        border-left: 4px solid #dc2626;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        max-width: 400px;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    toast.innerHTML = `
        <strong>Security Recommendations:</strong><br>
        - Review failed login patterns<br>
        - Consider implementing rate limiting<br>
        - Check for suspicious IP addresses<br>
        - Update security policies if needed
        <button onclick="this.parentElement.remove()" style="float: right; background: none; border: none; color: #dc2626; font-size: 1.2em;">&times;</button>
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 8000);
}

function showExportProgress() {
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #22c55e;
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 9999;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    toast.innerHTML = '<i class="fas fa-download me-2"></i>Preparing export...';
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    setTimeout(() => {
        toast.innerHTML = '<i class="fas fa-check me-2"></i>Export ready for download!';
    }, 2000);
    
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (document.body.contains(toast)) {
                document.body.removeChild(toast);
            }
        }, 300);
    }, 5000);
}

// Add ripple effects to action cards
document.querySelectorAll('.action-card').forEach(card => {
    card.addEventListener('click', function(e) {
        const rect = this.getBoundingClientRect();
        const ripple = document.createElement('div');
        const size = Math.max(rect.width, rect.height);
        const x = e.clientX - rect.left - size / 2;
        const y = e.clientY - rect.top - size / 2;
        
        ripple.style.cssText = `
            position: absolute;
            width: ${size}px;
            height: ${size}px;
            left: ${x}px;
            top: ${y}px;
            background: rgba(249, 115, 22, 0.3);
            border-radius: 50%;
            transform: scale(0);
            animation: ripple 0.6s ease-out;
            pointer-events: none;
        `;
        
        this.appendChild(ripple);
        
        setTimeout(() => {
            ripple.remove();
        }, 600);
    });
});

// Add ripple animation CSS
const style = document.createElement('style');
style.textContent = `
    @keyframes ripple {
        to {
            transform: scale(4);
            opacity: 0;
        }
    }
`;
document.head.appendChild(style);
</script>

{% endblock %}