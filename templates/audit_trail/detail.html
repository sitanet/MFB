{% extends "base.html" %}
{% load humanize %}

{% block content %}
<style>
:root {
    /* Orange & Green Theme - matching project colors */
    --primary-orange: #f97316;
    --primary-orange-dark: #ea580c;
    --primary-green: #16a34a;
    --primary-green-dark: #15803d;
    --success: #22c55e;
    --warning: #f59e0b;
    --danger: #ef4444;
    --info: #3b82f6;
    --light: #f8fafc;
    --dark: #0f172a;
    --gray-100: #f1f5f9;
    --gray-300: #cbd5e1;
    --gray-400: #94a3b8;
    --card-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
    --card-hover-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
}

.audit-detail-container {
    background: linear-gradient(135deg, #f0fdf4 0%, #fff7ed 100%);
    min-height: 100vh;
    padding: 1.5rem 0;
}

.audit-header {
    background: linear-gradient(135deg, var(--primary-orange) 0%, var(--primary-green) 100%);
    border-radius: 16px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: var(--card-shadow);
    color: white;
    position: relative;
    overflow: hidden;
}

.audit-header::before {
    content: "";
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0) 70%);
    transform: rotate(30deg);
}

.audit-header h2 {
    font-weight: 700;
    font-size: 2rem;
    margin-bottom: 0.5rem;
    position: relative;
    z-index: 2;
}

.audit-id-badge {
    background: rgba(255, 255, 255, 0.2);
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    display: inline-block;
    margin-top: 0.5rem;
    position: relative;
    z-index: 2;
}

.audit-card {
    background: white;
    border-radius: 16px;
    box-shadow: var(--card-shadow);
    margin-bottom: 2rem;
    overflow: hidden;
    transition: all 0.3s ease;
}

.audit-card:hover {
    box-shadow: var(--card-hover-shadow);
    transform: translateY(-2px);
}

.audit-card-header {
    background: linear-gradient(90deg, var(--gray-100) 0%, white 100%);
    padding: 1.5rem;
    border-bottom: 2px solid var(--gray-100);
}

.audit-card-header h4 {
    margin: 0;
    color: var(--dark);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.75rem;
}

.audit-card-body {
    padding: 2rem;
}

.info-row {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 1rem 0;
    border-bottom: 1px solid var(--gray-100);
}

.info-row:last-child {
    border-bottom: none;
    padding-bottom: 0;
}

.info-label {
    font-weight: 600;
    color: var(--gray-400);
    text-transform: uppercase;
    font-size: 0.75rem;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
    display: block;
}

.info-value {
    font-weight: 500;
    color: var(--dark);
    line-height: 1.4;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 50px;
    font-weight: 600;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.status-success { background: var(--success); color: white; }
.status-danger { background: var(--danger); color: white; }
.status-warning { background: var(--warning); color: white; }
.status-info { background: var(--info); color: white; }
.status-light { background: var(--gray-300); color: var(--dark); }

.compliance-critical { background: var(--danger); color: white; }
.compliance-high { background: var(--warning); color: white; }
.compliance-medium { background: var(--info); color: white; }
.compliance-low { background: var(--gray-300); color: var(--dark); }

.description-card {
    background: var(--light);
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    padding: 1.5rem;
    font-style: italic;
    color: var(--dark);
    line-height: 1.6;
}

.copyable-field {
    position: relative;
    display: inline-block;
}

.copy-btn {
    background: var(--primary-orange);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 0.25rem 0.5rem;
    font-size: 0.75rem;
    margin-left: 0.5rem;
    cursor: pointer;
    transition: all 0.2s ease;
}

.copy-btn:hover {
    background: var(--primary-orange-dark);
    transform: scale(1.05);
}

.amount-display {
    font-size: 1.25rem;
    font-weight: 700;
    color: var(--success);
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.technical-info {
    background: var(--gray-100);
    border-radius: 12px;
    padding: 1.5rem;
    font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    font-size: 0.875rem;
}

.quick-action-btn {
    display: block;
    width: 100%;
    padding: 0.75rem;
    margin-bottom: 0.75rem;
    border-radius: 12px;
    text-decoration: none;
    text-align: center;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-primary { 
    background: var(--primary-orange); 
    color: white; 
    border: 2px solid var(--primary-orange);
}

.btn-primary:hover { 
    background: var(--primary-orange-dark); 
    border-color: var(--primary-orange-dark);
    transform: translateY(-1px);
}

.btn-secondary { 
    background: var(--gray-300); 
    color: var(--dark); 
    border: 2px solid var(--gray-300);
}

.btn-info { 
    background: var(--info); 
    color: white; 
    border: 2px solid var(--info);
}

.btn-warning { 
    background: var(--warning); 
    color: white; 
    border: 2px solid var(--warning);
}

.related-activity-card {
    background: white;
    border: 1px solid var(--gray-200);
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
    transition: all 0.2s ease;
}

.related-activity-card:hover {
    border-color: var(--primary-orange);
    box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
}

.breadcrumb-modern {
    background: white;
    border-radius: 12px;
    padding: 1rem 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

.section-divider {
    height: 2px;
    background: linear-gradient(90deg, var(--primary-orange) 0%, var(--primary-green) 100%);
    border: none;
    border-radius: 2px;
    margin: 2rem 0;
}

.alert-modern {
    border: none;
    border-radius: 12px;
    padding: 1.5rem;
    font-weight: 500;
}

.alert-danger-modern {
    background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
    color: var(--danger);
    border-left: 4px solid var(--danger);
}

.alert-info-modern {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: var(--info);
    border-left: 4px solid var(--info);
}

.icon-circle {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.25rem;
}

.icon-orange { background: rgba(249, 115, 22, 0.1); color: var(--primary-orange); }
.icon-green { background: rgba(22, 163, 74, 0.1); color: var(--primary-green); }
.icon-blue { background: rgba(59, 130, 246, 0.1); color: var(--info); }
.icon-gray { background: var(--gray-100); color: var(--gray-400); }

@media (max-width: 768px) {
    .info-row {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .audit-header {
        padding: 1.5rem;
    }
    
    .audit-card-body {
        padding: 1.5rem;
    }
}
</style>

<div class="audit-detail-container">
    <div class="container-fluid">
        
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="breadcrumb-modern">
            <ol class="breadcrumb mb-0">
                <li class="breadcrumb-item"><a href="{% url 'audit_trail:dashboard' %}"><i class="fas fa-chart-line me-2"></i>Audit Dashboard</a></li>
                <li class="breadcrumb-item"><a href="{% url 'audit_trail:list' %}"><i class="fas fa-list me-2"></i>Audit Logs</a></li>
                <li class="breadcrumb-item active"><i class="fas fa-eye me-2"></i>Detail #{{ audit.id }}</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="audit-header">
            <h2><i class="fas fa-shield-alt me-3"></i>Audit Trail Detail</h2>
            <div class="audit-id-badge">
                <i class="fas fa-hashtag me-2"></i>Entry ID: {{ audit.id }}
                <button class="copy-btn ms-2" onclick="copyToClipboard('{{ audit.id }}')">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>

        <div class="row">
            <!-- Main Content -->
            <div class="col-lg-8">
                
                <!-- Essential Information -->
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle icon-orange"><i class="fas fa-info-circle"></i></div>Essential Information</h4>
                    </div>
                    <div class="audit-card-body">
                        <div class="info-row">
                            <div class="col-md-6">
                                <span class="info-label">Timestamp</span>
                                <div class="info-value">
                                    <i class="fas fa-clock text-primary me-2"></i>
                                    {{ audit.timestamp|date:"M d, Y" }} at {{ audit.timestamp|time:"H:i:s" }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <span class="info-label">User</span>
                                <div class="info-value">
                                    <i class="fas fa-user text-info me-2"></i>
                                    {{ audit.user_display|default:"System" }}
                                </div>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="col-md-6">
                                <span class="info-label">Action</span>
                                <div class="info-value">
                                    <span class="status-badge status-info">
                                        <i class="fas fa-bolt me-1"></i>{{ audit.get_action_display }}
                                    </span>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <span class="info-label">Category</span>
                                <div class="info-value">
                                    <span class="status-badge status-light">
                                        <i class="fas fa-tags me-1"></i>{{ audit.get_category_display }}
                                    </span>
                                </div>
                            </div>
                        </div>

                        <div class="info-row">
                            <div class="col-md-6">
                                <span class="info-label">Status</span>
                                <div class="info-value">
                                    {% if audit.success %}
                                        <span class="status-badge status-success">
                                            <i class="fas fa-check-circle me-1"></i>Success
                                        </span>
                                    {% else %}
                                        <span class="status-badge status-danger">
                                            <i class="fas fa-times-circle me-1"></i>Failed
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <span class="info-label">Compliance Level</span>
                                <div class="info-value">
                                    {% if audit.compliance_level == 'CRITICAL' %}
                                        <span class="status-badge compliance-critical">
                                            <i class="fas fa-exclamation-triangle me-1"></i>Critical
                                        </span>
                                    {% elif audit.compliance_level == 'HIGH' %}
                                        <span class="status-badge compliance-high">
                                            <i class="fas fa-exclamation me-1"></i>High
                                        </span>
                                    {% elif audit.compliance_level == 'MEDIUM' %}
                                        <span class="status-badge compliance-medium">
                                            <i class="fas fa-info me-1"></i>Medium
                                        </span>
                                    {% else %}
                                        <span class="status-badge compliance-low">
                                            <i class="fas fa-minus me-1"></i>Low
                                        </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Description -->
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle icon-blue"><i class="fas fa-align-left"></i></div>Description</h4>
                    </div>
                    <div class="audit-card-body">
                        <div class="description-card">
                            <i class="fas fa-quote-left me-2 text-muted"></i>
                            {{ audit.description }}
                            <i class="fas fa-quote-right ms-2 text-muted"></i>
                        </div>
                    </div>
                </div>

                <!-- Banking Information -->
                {% if audit.account_number or audit.customer_id or audit.transaction_reference or audit.amount %}
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle icon-green"><i class="fas fa-university"></i></div>Banking Information</h4>
                    </div>
                    <div class="audit-card-body">
                        {% if audit.account_number %}
                        <div class="info-row">
                            <div class="col-md-12">
                                <span class="info-label">Account Number</span>
                                <div class="info-value copyable-field">
                                    <code>{{ audit.account_number }}</code>
                                    <button class="copy-btn" onclick="copyToClipboard('{{ audit.account_number }}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if audit.customer_id %}
                        <div class="info-row">
                            <div class="col-md-12">
                                <span class="info-label">Customer ID</span>
                                <div class="info-value copyable-field">
                                    <code>{{ audit.customer_id }}</code>
                                    <button class="copy-btn" onclick="copyToClipboard('{{ audit.customer_id }}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if audit.transaction_reference %}
                        <div class="info-row">
                            <div class="col-md-12">
                                <span class="info-label">Transaction Reference</span>
                                <div class="info-value copyable-field">
                                    <code>{{ audit.transaction_reference }}</code>
                                    <button class="copy-btn" onclick="copyToClipboard('{{ audit.transaction_reference }}')">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        {% if audit.amount %}
                        <div class="info-row">
                            <div class="col-md-12">
                                <span class="info-label">Amount</span>
                                <div class="info-value">
                                    <div class="amount-display">
                                        <i class="fas fa-naira-sign me-1"></i>{{ audit.amount|floatformat:2|intcomma }}
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <!-- Technical Information -->
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle icon-gray"><i class="fas fa-cogs"></i></div>Technical Information</h4>
                    </div>
                    <div class="audit-card-body">
                        <div class="technical-info">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <strong>IP Address:</strong><br>
                                    <span class="text-primary">{{ audit.ip_address|default:"Not recorded" }}</span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Request Method:</strong><br>
                                    <span class="status-badge status-info">{{ audit.request_method|default:"Unknown" }}</span>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Request Path:</strong><br>
                                    <code>{{ audit.request_path|default:"Not recorded" }}</code>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <strong>Session Key:</strong><br>
                                    <code class="text-muted">{{ audit.session_key|default:"Not recorded"|truncatechars:20 }}</code>
                                </div>
                                {% if audit.duration_ms %}
                                <div class="col-md-6 mb-3">
                                    <strong>Duration:</strong><br>
                                    <span class="text-warning">{{ audit.duration_ms }} ms</span>
                                </div>
                                {% endif %}
                            </div>
                            
                            {% if audit.user_agent %}
                            <hr class="my-3">
                            <div>
                                <strong>User Agent:</strong><br>
                                <small class="text-muted">{{ audit.user_agent }}</small>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Error Messages & Changes -->
                {% if audit.error_message %}
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle" style="background: rgba(239, 68, 68, 0.1); color: var(--danger);"><i class="fas fa-exclamation-triangle"></i></div>Error Information</h4>
                    </div>
                    <div class="audit-card-body">
                        <div class="alert-modern alert-danger-modern">
                            <i class="fas fa-bug me-2"></i>
                            {{ audit.error_message }}
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if audit.changes_summary %}
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle icon-blue"><i class="fas fa-edit"></i></div>Changes Made</h4>
                    </div>
                    <div class="audit-card-body">
                        <div class="alert-modern alert-info-modern">
                            <i class="fas fa-clipboard-list me-2"></i>
                            {{ audit.changes_summary }}
                        </div>
                    </div>
                </div>
                {% endif %}

            </div>

            <!-- Sidebar -->
            <div class="col-lg-4">
                
                <!-- Related Activities -->
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle icon-orange"><i class="fas fa-history"></i></div>Related Activities</h4>
                    </div>
                    <div class="audit-card-body">
                        {% for related in related_audits %}
                        <div class="related-activity-card">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <small class="text-primary fw-bold">{{ related.timestamp|date:"M d, H:i" }}</small>
                                {% if related.success %}
                                    <i class="fas fa-check-circle text-success"></i>
                                {% else %}
                                    <i class="fas fa-times-circle text-danger"></i>
                                {% endif %}
                            </div>
                            <div class="mb-2">
                                <span class="status-badge status-info me-1">{{ related.get_action_display }}</span>
                                <span class="status-badge status-light">{{ related.get_category_display }}</span>
                            </div>
                            <p class="small text-muted mb-2">{{ related.description|truncatechars:60 }}</p>
                            <a href="{% url 'audit_trail:detail' related.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye me-1"></i>View Details
                            </a>
                        </div>
                        {% empty %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-3 d-block"></i>
                            <p>No related activities found in the same time period.</p>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="audit-card">
                    <div class="audit-card-header">
                        <h4><div class="icon-circle icon-green"><i class="fas fa-rocket"></i></div>Quick Actions</h4>
                    </div>
                    <div class="audit-card-body">
                        <a href="{% url 'audit_trail:list' %}" class="quick-action-btn btn-primary">
                            <i class="fas fa-list me-2"></i>Back to List
                        </a>
                        <a href="{% url 'audit_trail:dashboard' %}" class="quick-action-btn btn-secondary">
                            <i class="fas fa-chart-line me-2"></i>Dashboard
                        </a>
                        {% if audit.user %}
                        <a href="{% url 'audit_trail:list' %}?user={{ audit.user.id }}" class="quick-action-btn btn-info">
                            <i class="fas fa-user me-2"></i>Same User Activity
                        </a>
                        {% endif %}
                        <a href="{% url 'audit_trail:list' %}?category={{ audit.category }}" class="quick-action-btn btn-warning">
                            <i class="fas fa-tags me-2"></i>Same Category
                        </a>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

<!-- JavaScript for Copy to Clipboard -->
<script>
function copyToClipboard(text) {
    // Create a temporary textarea element
    const textarea = document.createElement('textarea');
    textarea.value = text;
    document.body.appendChild(textarea);
    
    // Select and copy the text
    textarea.select();
    textarea.setSelectionRange(0, 99999); // For mobile devices
    
    try {
        document.execCommand('copy');
        
        // Show a brief success indication
        const event = new CustomEvent('showToast', {
            detail: {
                message: 'Copied to clipboard!',
                type: 'success'
            }
        });
        document.dispatchEvent(event);
        
        // Fallback: Simple alert if toast system not available
        setTimeout(() => {
            if (!document.querySelector('.toast-container')) {
                // Simple visual feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i>';
                btn.style.backgroundColor = 'var(--success)';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.style.backgroundColor = 'var(--primary-orange)';
                }, 1000);
            }
        }, 100);
        
    } catch (err) {
        console.error('Failed to copy text: ', err);
        alert('Copy failed. Please manually select and copy the text.');
    }
    
    // Remove the temporary element
    document.body.removeChild(textarea);
}

// Toast notification system (if not already available)
function showToast(message, type = 'info') {
    // Create toast container if it doesn't exist
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        container.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            pointer-events: none;
        `;
        document.body.appendChild(container);
    }
    
    // Create toast element
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.style.cssText = `
        background: ${type === 'success' ? 'var(--success)' : 'var(--info)'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateX(100%);
        transition: transform 0.3s ease;
        pointer-events: auto;
        font-weight: 500;
    `;
    toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check' : 'info'}-circle me-2"></i>${message}`;
    
    container.appendChild(toast);
    
    // Animate in
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    // Animate out and remove
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (container.contains(toast)) {
                container.removeChild(toast);
            }
        }, 300);
    }, 3000);
}

// Listen for custom toast events
document.addEventListener('showToast', (e) => {
    showToast(e.detail.message, e.detail.type);
});
</script>

{% endblock %}