{% extends 'merchant/portal/base.html' %}
{% load humanize %}

{% block title %}FinanceFlex Transfer{% endblock %}

{% block content %}
<div class="page-header">
    <h4>FinanceFlex Transfer</h4>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'merchant:portal_dashboard' %}">Dashboard</a></li>
            <li class="breadcrumb-item active">Internal Transfer</li>
        </ol>
    </nav>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="form-section">
            <h5 class="section-title">
                <i class="fas fa-exchange-alt text-success me-2"></i>
                Transfer Within FinanceFlex
            </h5>
            
            <form method="post" id="transferForm">
                {% csrf_token %}
                
                <!-- Beneficiary Account -->
                <div class="mb-4">
                    <label for="beneficiary_account" class="form-label">Beneficiary Account Number</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="beneficiary_account" name="beneficiary_account" 
                               placeholder="Enter GL/AC number (e.g., 202011)" required>
                        <button class="btn btn-outline-primary" type="button" id="validateBtn">
                            <i class="fas fa-search"></i> Validate
                        </button>
                    </div>
                    <div class="form-text">Enter the recipient's account number within FinanceFlex</div>
                </div>
                
                <!-- Beneficiary Details (shown after validation) -->
                <div class="card bg-light mb-4 d-none" id="beneficiaryDetails">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <small class="text-muted">Account Name</small>
                                <p class="mb-0 fw-bold" id="beneficiaryName">-</p>
                            </div>
                            <div class="col-md-6">
                                <small class="text-muted">Account Number</small>
                                <p class="mb-0 fw-bold" id="beneficiaryAccount">-</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Amount -->
                <div class="mb-4">
                    <label for="amount" class="form-label">Amount</label>
                    <div class="input-group">
                        <span class="input-group-text">₦</span>
                        <input type="number" class="form-control" id="amount" name="amount" 
                               min="100" step="0.01" placeholder="0.00" required>
                    </div>
                </div>
                
                <!-- Narration -->
                <div class="mb-4">
                    <label for="narration" class="form-label">Narration</label>
                    <input type="text" class="form-control" id="narration" name="narration" 
                           maxlength="100" placeholder="Enter transfer description" required>
                </div>
                
                <!-- Transaction PIN -->
                <div class="mb-4">
                    <label for="transaction_pin" class="form-label">Transaction PIN</label>
                    <input type="password" class="form-control" id="transaction_pin" name="transaction_pin" 
                           maxlength="6" placeholder="Enter your PIN" required>
                </div>
                
                <hr>
                
                <div class="d-flex justify-content-between align-items-center">
                    <a href="{% url 'merchant:portal_dashboard' %}" class="btn btn-light">
                        <i class="fas fa-arrow-left me-2"></i> Back
                    </a>
                    <button type="submit" class="btn btn-success" id="submitBtn" disabled>
                        <i class="fas fa-paper-plane me-2"></i> Transfer
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Float Balance -->
        <div class="balance-card mb-4">
            <span class="balance-label">Your Float Balance</span>
            <h3 class="balance-amount">₦{{ float_balance|floatformat:2|intcomma }}</h3>
        </div>
        
        <!-- Transfer Info -->
        <div class="stats-card mb-4">
            <h6 class="mb-3"><i class="fas fa-info-circle me-2"></i>Transfer Info</h6>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-muted">Transfer Fee:</span>
                <strong class="text-success">FREE</strong>
            </div>
            <div class="d-flex justify-content-between">
                <span class="text-muted">Processing Time:</span>
                <strong>Instant</strong>
            </div>
        </div>
        
        <!-- Instructions -->
        <div class="stats-card">
            <h6 class="mb-3"><i class="fas fa-lightbulb me-2"></i>Tips</h6>
            <ul class="list-unstyled mb-0 small">
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Internal transfers are free</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Instant processing</li>
                <li class="mb-2"><i class="fas fa-check text-success me-2"></i>Validate before sending</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    var accountValidated = false;
    
    // Validate account
    $('#validateBtn').click(function() {
        var account = $('#beneficiary_account').val();
        
        if (!account) {
            alert('Please enter account number');
            return;
        }
        
        var btn = $(this);
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');
        
        $.get("{% url 'merchant:api_validate_customer' %}", {account: account}, function(data) {
            if (data.success) {
                $('#beneficiaryName').text(data.customer.name);
                $('#beneficiaryAccount').text(data.customer.account);
                $('#beneficiaryDetails').removeClass('d-none');
                accountValidated = true;
                updateSubmitButton();
            } else {
                alert(data.message || 'Account not found');
                $('#beneficiaryDetails').addClass('d-none');
                accountValidated = false;
                updateSubmitButton();
            }
        }).fail(function() {
            alert('Error validating account');
        }).always(function() {
            btn.prop('disabled', false).html('<i class="fas fa-search"></i> Validate');
        });
    });
    
    // Reset validation when account changes
    $('#beneficiary_account').on('change', function() {
        accountValidated = false;
        $('#beneficiaryDetails').addClass('d-none');
        updateSubmitButton();
    });
    
    function updateSubmitButton() {
        var amount = parseFloat($('#amount').val()) || 0;
        var pin = $('#transaction_pin').val();
        var narration = $('#narration').val();
        
        $('#submitBtn').prop('disabled', !accountValidated || amount < 100 || !pin || !narration);
    }
    
    $('#amount, #transaction_pin, #narration').on('input', updateSubmitButton);
});
</script>
{% endblock %}
