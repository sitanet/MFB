{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Branch</title>
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        :root {
            --primary-green: #28a745;
            --primary-orange: #fd7e14;
            --secondary-green: #5cb85c;
            --light-orange: #ffdfb9;
            --light-bg: #f8f9fa;
            --dark-text: #343a40;
            --border-radius: 0.5rem;
        }
        
        body {
            background-color: #f5f5f5;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            color: var(--dark-text);
        }
        
        .form-container {
            max-width: 750px;
            margin: 3rem auto;
            padding: 2.5rem;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: 0 0.5rem 1.5rem rgba(0, 0, 0, 0.08);
            border-top: 4px solid var(--primary-green);
        }
        
        .form-title {
            color: var(--primary-orange);
            font-weight: 700;
            margin-bottom: 1.75rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px dashed #eee;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .welcome-msg {
            background: linear-gradient(135deg, var(--light-orange) 0%, #fff 100%);
            padding: 1.25rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
            border-left: 4px solid var(--primary-orange);
        }
        
        .welcome-msg strong {
            color: var(--primary-green);
        }
        
        .form-section {
            margin-bottom: 1.5rem;
        }
        
        .form-label {
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: block;
            color: var(--primary-green);
        }
        
        .form-control {
            border-radius: var(--border-radius);
            padding: 0.85rem 1.15rem;
            border: 1px solid #ddd;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: var(--primary-orange);
            box-shadow: 0 0 0 0.2rem rgba(253, 126, 20, 0.25);
        }
        
        .form-error {
            color: #dc3545;
            font-size: 0.875rem;
            margin-top: 0.5rem;
            font-weight: 500;
        }
        
        .btn-primary {
            background: linear-gradient(to right, var(--primary-green), var(--secondary-green));
            border: none;
            padding: 1rem 1.5rem;
            font-weight: 600;
            width: 100%;
            border-radius: 50px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-primary:hover {
            background: linear-gradient(to right, var(--secondary-green), var(--primary-green));
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }
        
        .alert {
            border-radius: var(--border-radius);
            padding: 1.15rem;
            border-left: 4px solid;
        }
        
        .alert-info {
            background-color: rgba(23, 162, 184, 0.1);
            border-left-color: #17a2b8;
        }
        
        .alert-danger {
            background-color: rgba(220, 53, 69, 0.1);
            border-left-color: #dc3545;
        }
        
        select.form-control {
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%2328a745'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1rem;
        }
        
        .debug-panel {
            background-color: #f8f9fa;
            border-left: 4px solid var(--primary-orange);
            padding: 1.5rem;
            margin-top: 3rem;
            border-radius: var(--border-radius);
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
        }
        
        .debug-title {
            color: var(--primary-orange);
            font-weight: 700;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .form-container {
                padding: 1.75rem;
                margin: 1.5rem 0.75rem;
            }
            
            .form-title {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="form-container">
            <h2 class="form-title text-center">
                <i class="fas fa-code-branch mr-2"></i>Create Your Branch
            </h2>

            <!-- System Messages -->
            {% if messages %}
            <div class="alert alert-info">
                <h5 class="mb-2"><i class="fas fa-info-circle mr-2"></i>System Messages:</h5>
                <ul class="mb-0 pl-3">
                    {% for message in messages %}
                    <li>{{ message }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Welcome Section -->
            <div class="welcome-msg">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-1">Welcome, <strong>{{ first_name }} {{ last_name }}</strong>!</h5>
                        <p class="mb-0 text-muted">Please complete your branch setup below</p>
                    </div>
                    <i class="fas fa-user-circle fa-3x text-orange"></i>
                </div>
                
                {% if not phone_valid %}
                <div class="alert alert-danger mt-3 mb-0">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    <strong>Verification Required:</strong> Phone number {{ user_phone|default:"Not provided" }} needs verification
                </div>
                {% endif %}
            </div>

            <!-- Main Form -->
            <form method="post" enctype="multipart/form-data" novalidate>
                {% csrf_token %}

                {% for field in form.visible_fields %}
                    {% if field.name != "company_type" %}
                        <div class="form-section">
                            <label class="form-label">
                                <i class="fas fa-{% if field.name == 'phone_number' %}phone{% elif field.name == 'address' %}map-marker-alt{% else %}tag{% endif %} mr-2"></i>
                                {{ field.label }}
                            </label>

                            {% if field.field.widget.input_type == 'select' %}
                                <select name="{{ field.name }}" class="form-control">
                                    {% for choice in field.field.choices %}
                                        <option value="{{ choice.0 }}" {% if choice.0 == field.value %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                            {% elif field.field.widget.input_type == 'textarea' %}
                                <textarea name="{{ field.name }}" class="form-control" rows="4" style="resize: none;">{{ field.value }}</textarea>
                            {% else %}
                                <input type="{{ field.field.widget.input_type }}" name="{{ field.name }}"
                                       class="form-control" value="{{ field.value|default_if_none:'' }}">
                            {% endif %}

                            {% if field.errors %}
                                <div class="form-error">
                                    <i class="fas fa-exclamation-circle mr-1"></i>{{ field.errors.0 }}
                                </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}

                <!-- Company Type Dropdown -->
                <div class="form-section">
                    <label class="form-label">
                        <i class="fas fa-building mr-2"></i>Company Type
                    </label>
                    <select name="company_type" class="form-control">
                        <option value="">-- Select Company Type --</option>
                        <option value="MFB" {% if form.company_type.value == "MFB" %}selected{% endif %}>Microfinance Banks (MFBs)</option>
                        <option value="MFI" {% if form.company_type.value == "MFI" %}selected{% endif %}>Microfinance Institutions (MFIs)</option>
                        <option value="Fintech" {% if form.company_type.value == "Fintech" %}selected{% endif %}>Fintechs</option>
                        <option value="Neobank" {% if form.company_type.value == "Neobank" %}selected{% endif %}>Neobanks</option>
                        <option value="Cooperative" {% if form.company_type.value == "Cooperative" %}selected{% endif %}>Cooperative Societies / Saccos</option>
                        <option value="Lender" {% if form.company_type.value == "Lender" %}selected{% endif %}>Lenders</option>
                        <option value="NGO" {% if form.company_type.value == "NGO" %}selected{% endif %}>Financial NGOs</option>
                        <option value="Fund_Manager" {% if form.company_type.value == "Fund_Manager" %}selected{% endif %}>Funds Managers</option>
                    </select>
                    {% if form.company_type.errors %}
                        <div class="form-error">
                            <i class="fas fa-exclamation-circle mr-1"></i>{{ form.company_type.errors.0 }}
                        </div>
                    {% endif %}
                </div>

                <button type="submit" class="btn btn-primary mt-4">
                    <i class="fas fa-plus-circle mr-2"></i>Create Branch
                </button>
            </form>

            <!-- Debug Information -->
            {% if debug_info %}
            <div class="debug-panel">
                <div class="debug-title">
                    <i class="fas fa-bug mr-2"></i>Debug Information
                </div>
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-2"><strong><i class="fas fa-user mr-2 text-green"></i>User:</strong> {{ request.user.email }}</div>
                        <div class="mb-2"><strong><i class="fas fa-code-branch mr-2 text-green"></i>Branch Exists:</strong> {{ debug_info.has_branch|yesno:"Yes,No" }}</div>
                    </div>
                    <div class="col-md-6">
                        <div class="mb-2"><strong><i class="fas fa-phone mr-2 text-green"></i>Phone Number:</strong> {{ debug_info.phone_number|default:"Not provided" }}</div>
                        <div class="mb-2"><strong><i class="fas fa-check-circle mr-2 text-green"></i>Phone Valid:</strong> {{ debug_info.phone_valid|yesno:"Yes,No" }}</div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="mb-2"><strong><i class="fas fa-exclamation-triangle mr-2 text-orange"></i>Form Errors:</strong> {{ form.errors|default:"None" }}</div>
                    <div><strong><i class="fas fa-database mr-2 text-orange"></i>POST Data:</strong> {{ request.POST|default:"None" }}</div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
    <script>
    // Enhanced client-side validation with green/orange theme
    document.querySelector('form').addEventListener('submit', function(e) {
        const phoneInput = document.querySelector('[name="phone_number"]');
        if (phoneInput && !phoneInput.value.startsWith('+')) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger mb-3';
            alertDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle mr-2"></i>
                <strong>Validation Error:</strong> Phone number must start with country code (e.g. +234...)
            `;
            
            phoneInput.parentNode.insertBefore(alertDiv, phoneInput.nextSibling);
            
            // Scroll to the error with smooth animation
            setTimeout(() => {
                alertDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }, 100);
            
            // Highlight the input with orange border
            phoneInput.focus();
            phoneInput.classList.add('is-invalid');
            phoneInput.style.borderColor = 'var(--primary-orange)';
            
            e.preventDefault();
        }
    });
    </script>
</body>
</html>