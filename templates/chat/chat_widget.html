{% load static %}
<!-- Chat Widget - Bottom Right Popup -->
<div id="chat-widget-container">
    <!-- Chat Toggle Button -->
    <div id="chat-toggle-btn" onclick="toggleChatWidget()">
        <i class="fas fa-comments"></i>
        <span id="chat-unread-badge" class="chat-badge" style="display:none;">0</span>
    </div>
    
    <!-- Chat Widget Panel -->
    <div id="chat-widget-panel" style="display:none;">
        <div class="chat-widget-header">
            <h6 class="mb-0"><i class="fas fa-comments mr-2"></i> Chat</h6>
            <button type="button" class="close-btn" onclick="toggleChatWidget()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="chat-widget-body">
            <!-- Chat List View -->
            <div id="chat-list-view">
                <div class="chat-widget-search">
                    <input type="text" id="widget-search-staff" class="form-control form-control-sm" placeholder="Search staff...">
                    <div id="widget-search-results" style="display:none;"></div>
                </div>
                <div id="chat-conversations-list">
                    <div class="text-center p-3 text-muted">
                        <i class="fas fa-spinner fa-spin"></i> Loading...
                    </div>
                </div>
            </div>
            
            <!-- Chat Room View -->
            <div id="chat-room-view" style="display:none;">
                <div class="chat-room-header">
                    <button class="btn btn-sm btn-link" onclick="showChatList()">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <span id="chat-room-title">Chat</span>
                </div>
                <div id="chat-messages-container">
                    <!-- Messages will be loaded here -->
                </div>
                <div class="chat-input-area">
                    <input type="text" id="chat-message-input" class="form-control form-control-sm" placeholder="Type a message...">
                    <button class="btn btn-primary btn-sm" onclick="sendChatMessage()">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
#chat-widget-container {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 9999;
    font-family: inherit;
}

#chat-toggle-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 4px 15px rgba(0, 123, 255, 0.4);
    transition: transform 0.3s, box-shadow 0.3s;
    font-size: 24px;
    position: relative;
}

#chat-toggle-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 123, 255, 0.5);
}

.chat-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    background: #dc3545;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    font-size: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
}

#chat-widget-panel {
    position: absolute;
    bottom: 70px;
    right: 0;
    width: 350px;
    height: 450px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 5px 30px rgba(0,0,0,0.2);
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

.chat-widget-header {
    background: linear-gradient(135deg, #007bff, #0056b3);
    color: white;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.chat-widget-header .close-btn {
    background: none;
    border: none;
    color: white;
    font-size: 18px;
    cursor: pointer;
    opacity: 0.8;
}

.chat-widget-header .close-btn:hover {
    opacity: 1;
}

.chat-widget-body {
    flex: 1;
    overflow: hidden;
    display: flex;
    flex-direction: column;
}

.chat-widget-search {
    padding: 10px;
    border-bottom: 1px solid #eee;
    position: relative;
}

#widget-search-results {
    position: absolute;
    top: 100%;
    left: 10px;
    right: 10px;
    background: white;
    border: 1px solid #ddd;
    border-radius: 4px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 10;
}

#widget-search-results .search-item {
    padding: 8px 12px;
    cursor: pointer;
    border-bottom: 1px solid #eee;
}

#widget-search-results .search-item:hover {
    background: #f8f9fa;
}

#chat-conversations-list {
    flex: 1;
    overflow-y: auto;
}

.chat-conv-item {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    display: flex;
    align-items: center;
    transition: background 0.2s;
}

.chat-conv-item:hover {
    background: #f8f9fa;
}

.chat-conv-item.unread {
    background: #e8f4fd;
}

.chat-conv-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-right: 12px;
    flex-shrink: 0;
}

.chat-conv-info {
    flex: 1;
    min-width: 0;
}

.chat-conv-name {
    font-weight: 600;
    font-size: 14px;
    color: #333;
    margin-bottom: 2px;
}

.chat-conv-preview {
    font-size: 12px;
    color: #666;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.chat-conv-badge {
    background: #007bff;
    color: white;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    font-size: 11px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 8px;
}

/* Chat Room View */
.chat-room-header {
    padding: 10px;
    border-bottom: 1px solid #eee;
    display: flex;
    align-items: center;
    background: #f8f9fa;
}

.chat-room-header .btn-link {
    color: #007bff;
    padding: 0;
    margin-right: 10px;
}

#chat-room-title {
    font-weight: 600;
    font-size: 14px;
}

#chat-messages-container {
    flex: 1;
    overflow-y: auto;
    padding: 10px;
    background: #f5f5f5;
}

.chat-message {
    margin-bottom: 10px;
    max-width: 80%;
}

.chat-message.sent {
    margin-left: auto;
}

.chat-message .message-bubble {
    padding: 8px 12px;
    border-radius: 12px;
    font-size: 13px;
}

.chat-message.received .message-bubble {
    background: white;
    border: 1px solid #e0e0e0;
}

.chat-message.sent .message-bubble {
    background: #007bff;
    color: white;
}

.chat-message .message-time {
    font-size: 10px;
    color: #999;
    margin-top: 3px;
}

.chat-message.sent .message-time {
    text-align: right;
}

.chat-input-area {
    padding: 10px;
    border-top: 1px solid #eee;
    display: flex;
    gap: 8px;
    background: white;
}

.chat-input-area input {
    flex: 1;
}

.no-conversations {
    text-align: center;
    padding: 30px;
    color: #999;
}

.no-conversations i {
    font-size: 40px;
    margin-bottom: 10px;
}

#chat-list-view, #chat-room-view {
    flex: 1;
    display: flex;
    flex-direction: column;
    overflow: hidden;
}

@media (max-width: 576px) {
    #chat-widget-panel {
        width: 300px;
        height: 400px;
        right: -10px;
    }
}
</style>

<script>
var chatWidgetOpen = false;
var currentChatRoom = null;
var chatRefreshInterval = null;
var currentUserId = {{ user.id|default:"null" }};

function toggleChatWidget() {
    chatWidgetOpen = !chatWidgetOpen;
    var panel = document.getElementById('chat-widget-panel');
    panel.style.display = chatWidgetOpen ? 'flex' : 'none';
    
    if (chatWidgetOpen) {
        loadChatConversations();
        startUnreadCheck();
    } else {
        showChatList();
        stopChatRefresh();
    }
}

function loadChatConversations() {
    fetch('/chat/')
        .then(response => response.text())
        .then(html => {
            var parser = new DOMParser();
            var doc = parser.parseFromString(html, 'text/html');
            var chatItems = doc.querySelectorAll('.chat-item');
            var listHtml = '';
            
            if (chatItems.length === 0) {
                listHtml = '<div class="no-conversations"><i class="fas fa-comments"></i><p>No conversations yet</p><p class="small">Search for staff to start chatting</p></div>';
            } else {
                chatItems.forEach(function(item) {
                    var href = item.getAttribute('href');
                    var roomUuid = href.match(/room\/([^\/]+)/);
                    if (roomUuid) {
                        var nameEl = item.querySelector('h6');
                        var previewEl = item.querySelector('small.text-muted');
                        var badgeEl = item.querySelector('.badge');
                        var avatarEl = item.querySelector('.avatar-circle');
                        
                        var name = nameEl ? nameEl.textContent.trim() : 'Unknown';
                        var preview = previewEl ? previewEl.textContent.trim() : '';
                        var unread = badgeEl ? parseInt(badgeEl.textContent) : 0;
                        var initials = avatarEl ? avatarEl.textContent.trim() : name.substring(0, 2).toUpperCase();
                        
                        listHtml += '<div class="chat-conv-item ' + (unread > 0 ? 'unread' : '') + '" onclick="openChatRoom(\'' + roomUuid[1] + '\', \'' + name.replace(/'/g, "\\'") + '\')">';
                        listHtml += '<div class="chat-conv-avatar">' + initials + '</div>';
                        listHtml += '<div class="chat-conv-info">';
                        listHtml += '<div class="chat-conv-name">' + name + '</div>';
                        listHtml += '<div class="chat-conv-preview">' + preview + '</div>';
                        listHtml += '</div>';
                        if (unread > 0) {
                            listHtml += '<div class="chat-conv-badge">' + unread + '</div>';
                        }
                        listHtml += '</div>';
                    }
                });
            }
            
            document.getElementById('chat-conversations-list').innerHTML = listHtml;
        })
        .catch(function() {
            document.getElementById('chat-conversations-list').innerHTML = '<div class="p-3 text-center text-muted">Unable to load conversations</div>';
        });
}

function openChatRoom(roomUuid, roomName) {
    currentChatRoom = roomUuid;
    document.getElementById('chat-list-view').style.display = 'none';
    document.getElementById('chat-room-view').style.display = 'flex';
    document.getElementById('chat-room-title').textContent = roomName;
    loadChatMessages();
    startChatRefresh();
}

function showChatList() {
    currentChatRoom = null;
    document.getElementById('chat-room-view').style.display = 'none';
    document.getElementById('chat-list-view').style.display = 'flex';
    stopChatRefresh();
    loadChatConversations();
}

function loadChatMessages() {
    if (!currentChatRoom) return;
    
    fetch('/chat/messages/' + currentChatRoom + '/')
        .then(response => response.json())
        .then(data => {
            var container = document.getElementById('chat-messages-container');
            var html = '';
            var messages = data.messages || [];
            
            messages.forEach(function(msg) {
                var isSent = msg.sender_id === currentUserId || msg.is_own;
                html += '<div class="chat-message ' + (isSent ? 'sent' : 'received') + '">';
                html += '<div class="message-bubble">' + escapeHtml(msg.content) + '</div>';
                html += '<div class="message-time">' + (msg.timestamp || msg.created_at) + '</div>';
                html += '</div>';
            });
            
            container.innerHTML = html || '<div class="text-center p-3 text-muted">No messages yet</div>';
            container.scrollTop = container.scrollHeight;
        });
}

function sendChatMessage() {
    var input = document.getElementById('chat-message-input');
    var content = input.value.trim();
    
    if (!content || !currentChatRoom) return;
    
    fetch('/chat/send/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({room_uuid: currentChatRoom, content: content})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            input.value = '';
            loadChatMessages();
        }
    });
}

function startChatRefresh() {
    stopChatRefresh();
    chatRefreshInterval = setInterval(loadChatMessages, 3000);
}

function stopChatRefresh() {
    if (chatRefreshInterval) {
        clearInterval(chatRefreshInterval);
        chatRefreshInterval = null;
    }
}

function startUnreadCheck() {
    checkUnreadCount();
    setInterval(checkUnreadCount, 30000);
}

function checkUnreadCount() {
    fetch('/chat/unread/')
        .then(response => response.json())
        .then(data => {
            var badge = document.getElementById('chat-unread-badge');
            if (data.unread_count > 0) {
                badge.textContent = data.unread_count > 99 ? '99+' : data.unread_count;
                badge.style.display = 'flex';
            } else {
                badge.style.display = 'none';
            }
        });
}

function escapeHtml(text) {
    var div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    var cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        var cookies = document.cookie.split(';');
        for (var i = 0; i < cookies.length; i++) {
            var cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Enter key to send message
document.addEventListener('DOMContentLoaded', function() {
    var msgInput = document.getElementById('chat-message-input');
    if (msgInput) {
        msgInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }
    
    // Search functionality
    var searchInput = document.getElementById('widget-search-staff');
    var searchTimeout;
    if (searchInput) {
        searchInput.addEventListener('input', function() {
            var query = this.value;
            clearTimeout(searchTimeout);
            
            if (query.length < 2) {
                document.getElementById('widget-search-results').style.display = 'none';
                return;
            }
            
            searchTimeout = setTimeout(function() {
                fetch('/chat/search/?q=' + encodeURIComponent(query))
                    .then(response => response.json())
                    .then(data => {
                        var html = '';
                        if (data.results.length > 0) {
                            data.results.forEach(function(staff) {
                                html += '<div class="search-item" onclick="startNewChat(' + staff.id + ')">';
                                html += '<strong>' + staff.name + '</strong><br>';
                                html += '<small class="text-muted">' + staff.branch + '</small>';
                                html += '</div>';
                            });
                        } else {
                            html = '<div class="p-2 text-muted">No results</div>';
                        }
                        var results = document.getElementById('widget-search-results');
                        results.innerHTML = html;
                        results.style.display = 'block';
                    });
            }, 300);
        });
    }
    
    // Check unread on page load
    checkUnreadCount();
});

function startNewChat(userId) {
    // Start chat via AJAX and open in widget instead of redirecting
    fetch('/chat/start/' + userId + '/', {
        method: 'GET',
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Clear search input and results
            document.getElementById('widget-search-staff').value = '';
            document.getElementById('widget-search-results').style.display = 'none';
            // Open chat in widget
            openChatRoom(data.room_uuid, data.room_name);
        } else {
            loadChatConversations();
        }
    })
    .catch(() => {
        loadChatConversations();
    });
}
</script>
