{% extends 'base.html' %}

{% block content %}
<style>
  @media print {
    @page {
      size: A4 portrait;
      margin: 20mm 15mm 20mm 15mm;
    }
    body {
      -webkit-print-color-adjust: exact; /* print background colors */
      print-color-adjust: exact;
      font-size: 12pt;
      line-height: 1.4;
      color: #000 !important;
      background: #fff !important;
    }
    button {
      display: none !important;
    }
    .container {
      width: auto !important;
      max-width: 100% !important;
      padding: 0 !important;
      margin: 0 !important;
    }
    table {
      page-break-inside: auto;
      width: 100%;
      border-collapse: collapse;
      font-size: 11pt;
    }
    thead {
      display: table-header-group;
    }
    tbody {
      display: table-row-group;
    }
    tr {
      page-break-inside: avoid;
      page-break-after: auto;
    }
  }
</style>

<div class="container py-4">

  <!-- Top Actions -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-bold">Loan Repayment Report</h2>
    <div>
      <button onclick="window.print()" class="btn btn-outline-secondary btn-sm">Print</button>
      <button class="btn btn-outline-info btn-sm">Help</button>
    </div>
  </div>

  <!-- Filter Form -->
  {% if not repayment_list %}
  <form method="post" class="card p-4 shadow-sm mb-5">
    {% csrf_token %}
    <div class="row g-3 align-items-end">
      <div class="col-md-3">
        <label class="form-label">{{ form.start_date.label }}</label>
        {{ form.start_date }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ form.end_date.label }}</label>
        {{ form.end_date }}
      </div>
      <div class="col-md-3">
        <label class="form-label">{{ form.branch.label }}</label>
        {{ form.branch }}
      </div>
      <div class="col-md-2">
        <label class="form-label">{{ form.gl_no.label }}</label>
        {{ form.gl_no }}
      </div>
      <div class="col-md-1">
        <label class="form-label">{{ form.cycle.label }}</label>
        {{ form.cycle }}
      </div>
      <div class="col-md-12 text-end">
        <button type="submit" class="btn btn-primary mt-3">Generate Report</button>
      </div>
    </div>
  </form>
  {% endif %}

  <!-- Report Output -->
  {% if repayment_list %}
  <div class="mb-4">
    <h5 class="fw-bold text-uppercase">Loan Repayment Report</h5>
    <p class="text-muted mb-1">Branch: {{ branch_name }} | Period: {{ start_date }} to {{ end_date }}</p>
    <p class="text-muted">Date Generated: {{ current_date }}</p>
  </div>

  <!-- Summary Cards -->
  <div class="row text-white text-center mb-4">
    <div class="col-md-3">
      <div class="p-3 bg-primary rounded shadow-sm">
        <h6>PRINCIPAL PAID</h6>
        <p class="fs-5">₦{{ grand_total_principal }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-info rounded shadow-sm">
        <h6>INTEREST PAID</h6>
        <p class="fs-5">₦{{ grand_total_interest }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-danger rounded shadow-sm">
        <h6>PENALTY PAID</h6>
        <p class="fs-5">₦{{ grand_total_penalty }}</p>
      </div>
    </div>
    <div class="col-md-3">
      <div class="p-3 bg-warning text-dark rounded shadow-sm">
        <h6>TOTAL PAID</h6>
        <p class="fs-5">₦{{ total_paid_sum }}</p>
      </div>
    </div>
  </div>

  {% if loan %}
  <div class="row text-white text-center mb-4">
    <div class="col-md-6">
      <div class="p-3 bg-primary rounded shadow-sm">
        <h6>TOTAL DISBURSED</h6>
        <p class="fs-5">₦{{ grand_total_disbursed }}</p>
      </div>
    </div>
    <div class="col-md-6">
      <div class="p-3 bg-secondary rounded shadow-sm">
        <h6>OUTSTANDING AMOUNT</h6>
        <p class="fs-5">₦{{ outstanding_amount }}</p>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Detailed Table -->
  <div class="table-responsive">
    <table class="table table-bordered table-striped">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Customer</th>
          <th>Branch</th>
          <th>GL No</th>
          <th>Ac No</th>
          <th>Cycle</th>
          <th>Date</th>
          <th>Trx No</th>
          <th>Principal</th>
          <th>Interest</th>
          <th>Penalty</th>
          <th>Total Paid</th>
        </tr>
      </thead>
      <tbody>
        {% for row in repayment_list %}
        <tr>
          <td>{{ row.counter }}</td>
          <td>{{ row.customer_name }}</td>
          <td>{{ row.branch_name }}</td>
          <td>{{ row.gl_no }}</td>
          <td>{{ row.ac_no }}</td>
          <td>{{ row.cycle }}</td>
          <td>{{ row.trx_date|date:"d/m/Y" }}</td>
          <td>{{ row.trx_no }}</td>
          <td>{{ row.principal }}</td>
          <td>{{ row.interest }}</td>
          <td>{{ row.penalty }}</td>
          <td>{{ row.total_paid }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %}
</div>
{% endblock %}
