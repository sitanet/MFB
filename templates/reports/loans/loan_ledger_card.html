{% extends 'base.html' %}
{% load static %}

{% block content %}
{% include 'includes/alerts.html' %}

<style>
    .container-fluid { padding: 20px; font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; }
    .page_title h2 { margin: 0; color: #1e3a8a; font-weight: bold; }
    h5 { margin: 10px 0; color: #2563eb; }
    p { margin-bottom: 5px; color: #444; }
    
    /* Card Styling */
    .card { border: none; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .card-body { padding: 20px; }

    /* Form */
    .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1; min-width: 220px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 600; color: #333; }
    .form-group select, .form-group input {
        width: 100%; padding: 7px; border: 1px solid #ccc;
        border-radius: 8px; transition: border-color 0.3s;
    }
    .form-group select:focus, .form-group input:focus { border-color: #2563eb; outline: none; }
    .btn-primary { background-color: #2563eb; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; }
    .btn-primary:hover { background-color: #1e40af; }

    /* Print Button */
    .print-button {
        background-color: #16a34a; color: #fff; border: none;
        border-radius: 8px; padding: 10px 22px; font-size: 16px;
        font-weight: 600; cursor: pointer; transition: 0.3s;
        box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    .print-button:hover { background-color: #14532d; }

    /* Table */
    .table { width: 100%; margin-top: 15px; border-collapse: collapse; border-radius: 10px; overflow: hidden; }
    th, td { padding: 10px; text-align: left; }
    th { background-color: #1e3a8a; color: #fff; font-weight: 600; }
    tr:nth-child(even) { background-color: #f9fafb; }
    tr:hover { background-color: #eef2ff; transition: 0.2s; }
    .negative-value { color: #dc2626; font-weight: 600; }

    /* Totals row */
    tfoot tr { background-color: #f1f5f9; border-top: 3px solid #1e3a8a; font-weight: bold; }
    tfoot td { color: #1e293b; }

    /* Office heading */
    .office-address { margin-bottom: 20px; font-style: italic; color: #555; }

    /* Print-specific */
    @media print {
        body { font-size: 12px; }
        .no-print { display: none !important; }
        .container-fluid { padding: 0; }
        th, td { border: 1px solid #000 !important; }
        .table { border: 1px solid #000; }
        .card, .btn, .print-button { box-shadow: none !important; }
    }
</style>

<div class="container-fluid">
    <div class="row column_title">
        <div class="col-md-12">
            <div class="page_title text-center">
                <h2>Loan Ledger Card</h2>
            </div>
        </div>
    </div>

    <!-- Print Button -->
    <div class="text-right no-print mb-3">
        <button class="print-button" onclick="window.print()">üñ® Print</button>
    </div>

    <!-- Error Message -->
    {% if error_message %}
        <div class="alert alert-danger mt-3">‚ö†Ô∏è {{ error_message }}</div>
    {% endif %}

    <!-- Form Card -->
    <div id="form-container" class="card" {% if form_submitted %}style="display:none;"{% endif %}>
        <div class="card-body">
            <form id="loan-form" method="post" action="{% url 'loan_ledger_card' %}">
                {% csrf_token %}
                <div class="form-row">
                    <div class="form-group">
                        <label for="branch">Branch:</label>
                        <select id="branch" name="branch" class="form-control">
                            <option value="">Select a Branch</option>
                            {% for b in branches %}
                                <option value="{{ b.id }}" {% if request.POST.branch == b.id|stringformat:"s" %}selected{% endif %}>
                                    {{ b.branch_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="account">Account:</label>
                        <select id="account" name="account" class="form-control">
                            <option value="">Select an Account</option>
                            {% for a in accounts %}
                                <option value="{{ a.id }}" {% if request.POST.account == a.id|stringformat:"s" %}selected{% endif %}>
                                    {{ a.gl_no }} - {{ a.gl_name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="ac_no">Account No:</label>
                        <input type="text" id="ac_no" name="ac_no" class="form-control" value="{{ request.POST.ac_no }}">
                    </div>
                    <div class="form-group">
                        <label for="cycle">Cycle:</label>
                        <input type="text" id="cycle" name="cycle" class="form-control" value="{{ request.POST.cycle }}">
                    </div>
                    <div class="form-group" style="flex:0 0 auto; align-self:flex-end;">
                        <button type="submit" class="btn btn-primary">üîç Submit</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Loan Ledger Card -->
    {% if form_submitted %}
        {% if ledger_card %}
            <div class="card">
                <div class="card-body">
                    <div class="text-center mb-3">
                        <h4>{{ branch.company.company_name }}</h4>
                        <p class="office-address">{{ branch.branch_name }} - {{ branch.office_address }}</p>
                        <h5>üìë Loan Ledger Card</h5>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <p><strong>Full Name:</strong> {{ customer.get_full_name }}</p>
                            <p><strong>Address:</strong> {{ customer.address }}</p>
                            <p><strong>Product No:</strong> {{ customer.gl_no }}</p>
                            <p><strong>Loan & Cycle:</strong> {{ customer.ac_no }} . {{ loan.cycle }}</p>
                            <p><strong>Disbursement:</strong> {{ disbursement_amount }}</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>Period:</strong> {{ num_installments }} months</p>
                            <p><strong>Disbursement Date:</strong> {{ disbursement_date }}</p>
                            <p><strong>No of Installments:</strong> {{ num_installments }}</p>
                            <p><strong>Interest Rate:</strong> {{ annual_interest_rate }}%</p>
                        </div>
                    </div>

                    <div class="table-responsive-sm">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Trx Date</th>
                                    <th>Narration</th>
                                    <th>Cycle</th>
                                    <th>Principal</th>
                                    <th>Interest</th>
                                    <th>Penalty</th>
                                    <th>Total Payment</th>
                                    <th>Principal Bal</th>
                                    <th>Interest Bal</th>
                                    <th>Penalty Bal</th>
                                    <th>Total Bal</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for entry in ledger_card %}
                                    <tr>
                                        <td>{{ entry.trx_date }}</td>
                                        <td>{{ entry.trx_naration }}</td>
                                        <td>{{ entry.cycle }}</td>
                                        <td class="{% if entry.principal < 0 %}negative-value{% endif %}">{{ entry.principal }}</td>
                                        <td class="{% if entry.interest < 0 %}negative-value{% endif %}">{{ entry.interest }}</td>
                                        <td class="{% if entry.penalty < 0 %}negative-value{% endif %}">{{ entry.penalty }}</td>
                                        <td>{{ entry.total_payment }}</td>
                                        <td>{{ entry.principal_balance }}</td>
                                        <td>{{ entry.interest_balance }}</td>
                                        <td>{{ entry.penalty_balance }}</td>
                                        <td>{{ entry.total_balance }}</td>
                                    </tr>
                                {% empty %}
                                    <tr><td colspan="11" class="text-center">No records found</td></tr>
                                {% endfor %}
                            </tbody>
                            {% if ledger_card %}
                                <tfoot>
                                    <tr>
                                        <td colspan="3">Total</td>
                                        <td>{{ total_principal }}</td>
                                        <td>{{ total_interest }}</td>
                                        <td>{{ total_penalty }}</td>
                                        <td>{{ total_payment }}</td>
                                        <td>{{ total_principal_balance }}</td>
                                        <td>{{ total_interest_balance }}</td>
                                        <td>{{ total_penalty_balance }}</td>
                                        <td>{{ total_balance }}</td>
                                    </tr>
                                </tfoot>
                            {% endif %}
                        </table>
                    </div>
                </div>
            </div>
        {% else %}
            <div class="alert alert-info text-center">‚ÑπÔ∏è No records found for the provided criteria.</div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}
                                            