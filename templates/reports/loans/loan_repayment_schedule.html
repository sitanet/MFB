{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">

<style>
  body {
    background: #f5f6f8;
    font-family: "Segoe UI", Tahoma, sans-serif;
    font-size: 14px;
    color: #333;
  }

  .container-report {
    max-width: 1000px;
    margin: 20px auto;
    padding: 15px;
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 6px;
  }

  .report-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 8px;
    margin-bottom: 15px;
    border-bottom: 2px solid #444;
  }

  .report-title {
    font-size: 18px;
    font-weight: bold;
    color: #004d4d;
  }

  .actions button {
    margin-left: 6px;
    font-size: 13px;
  }

  .card {
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 12px;
    margin-bottom: 15px;
    background: #fafafa;
  }

  .form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
    gap: 12px;
  }

  .form-group label {
    font-weight: 600;
    font-size: 12px;
    margin-bottom: 4px;
    display: block;
  }

  .form-control {
    font-size: 13px;
    padding: 6px 8px;
    border-radius: 4px;
  }

  .btn-primary, .btn-success {
    font-size: 13px;
    font-weight: 600;
    padding: 6px 14px;
    border-radius: 4px;
  }

  /* Summary */
  .summary-row {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    margin-bottom: 15px;
  }

  .summary {
    flex: 1;
    min-width: 150px;
    border: 1px solid #ccc;
    border-radius: 4px;
    padding: 8px;
    background: #fff;
    text-align: center;
  }

  .summary .label {
    font-size: 12px;
    color: #666;
    font-weight: 600;
  }

  .summary .value {
    font-weight: bold;
    font-size: 15px;
    color: #004d4d;
    margin-top: 4px;
  }

  /* Table */
  .table-wrap {
    overflow-x: auto;
  }

  table.report-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 12.5px;
  }

  table.report-table th,
  table.report-table td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: right;
  }

  table.report-table th {
    background: #004d4d;
    color: #fff;
    text-align: center;
    font-size: 12px;
    font-weight: bold;
  }

  table.report-table td.left {
    text-align: left;
  }

  table.report-table tbody tr:nth-child(even) {
    background: #f9f9f9;
  }

  .total-row {
    background: #004d4d;
    color: white;
    font-weight: bold;
  }

  /* Print */
  @media print {
    .no-print { display: none !important; }
    body { background: white !important; }
    .container-report { border: none; padding: 0; }
    table.report-table { font-size: 9pt; }
  }
</style>

<div class="container-report">

  <div class="report-header">
    <div class="report-title">Loan Repayment Schedule</div>
    <div class="actions no-print">
      <button class="btn btn-primary btn-sm" onclick="window.print()">Print</button>
      <button class="btn btn-outline-secondary btn-sm" onclick="alert('Export not implemented')">Export</button>
    </div>
  </div>

  {% if error_message %}
    <div class="alert alert-danger">{{ error_message }}</div>
  {% endif %}

  <div class="card no-print">
    <form method="post" id="loan-search-form">
      {% csrf_token %}
      <div class="form-row">
        <div class="form-group">
          <label>Branch</label>
          {{ form.branch }}
        </div>
        <div class="form-group">
          <label>Account (GL)</label>
          {{ form.account }}
        </div>
        <div class="form-group">
          <label>Account No</label>
          <input name="ac_no" id="ac_no" class="form-control" value="{{ ac_no_value|default:'' }}">
        </div>
        <div class="form-group">
          <label>Cycle</label>
          <input name="cycle" id="cycle" class="form-control" value="{{ cycle_value|default:'' }}">
        </div>
      </div>
      <div class="d-flex justify-content-end mt-3">
        <button type="submit" class="btn btn-success">Generate Report</button>
      </div>
    </form>
  </div>

  {% if form_submitted %}
    <div class="summary-row">
      <div class="summary"><div class="label">Total Disbursed</div><div class="value">₦ {{ grand_total_disbursed|floatformat:2|intcomma }}</div></div>
      <div class="summary"><div class="label">Principal Paid</div><div class="value">₦ {{ grand_total_principal|floatformat:2|intcomma }}</div></div>
      <div class="summary"><div class="label">Interest Paid</div><div class="value">₦ {{ grand_total_interest|floatformat:2|intcomma }}</div></div>
      <div class="summary"><div class="label">Penalty Paid</div><div class="value">₦ {{ grand_total_penalty|floatformat:2|intcomma }}</div></div>
      <div class="summary"><div class="label">Outstanding</div><div class="value">₦ {{ outstanding_amount|floatformat:2|intcomma }}</div></div>
    </div>

    <div class="card">
      <div class="d-flex justify-content-between flex-wrap">
        <div>
          <strong>{{ company_name|default:"—" }}</strong><br>
          <small>{{ branch_name|default:"—" }}</small>
        </div>
        <div class="text-end">
          <div><strong>Customer:</strong> {{ customer_name|default:"—" }}</div>
          <div><strong>Loan/Acct:</strong>
            {% if loan %}{{ loan.ac_no }} · Cycle {{ loan.cycle }}{% else %}{{ ac_no_value|default:"—" }}{% endif %}
          </div>
        </div>
      </div>
    </div>

    <div class="table-wrap">
      <table class="report-table">
        <thead>
          <tr>
            <th>#</th>
            <th class="left">Date</th>
            <th class="left">Trx</th>
            <th class="left">Narration</th>
            <th>Cyc</th>
            <th>Prin</th>
            <th>Int</th>
            <th>Pen</th>
            <th>Total Paid</th>
            <th>Prin Bal</th>
            <th>Int Bal</th>
            <th>Pen Bal</th>
            <th>Total Bal</th>
          </tr>
        </thead>
        <tbody>
          {% for entry in ledger_card %}
            <tr>
              <td class="left">{{ entry.counter }}</td>
              <td class="left">{{ entry.trx_date|date:"d/m/Y" }}</td>
              <td class="left">{{ entry.trx_no|truncatechars:10 }}</td>
              <td class="left">{{ entry.trx_naration|default:entry.trx_type|truncatechars:20 }}</td>
              <td>{{ entry.cycle }}</td>
              <td>₦ {{ entry.principal|floatformat:2|intcomma }}</td>
              <td>₦ {{ entry.interest|floatformat:2|intcomma }}</td>
              <td>₦ {{ entry.penalty|floatformat:2|intcomma }}</td>
              <td>₦ {{ entry.total_payment|floatformat:2|intcomma }}</td>
              <td>₦ {{ entry.principal_balance|floatformat:2|intcomma }}</td>
              <td>₦ {{ entry.interest_balance|floatformat:2|intcomma }}</td>
              <td>₦ {{ entry.penalty_balance|floatformat:2|intcomma }}</td>
              <td>₦ {{ entry.total_balance|floatformat:2|intcomma }}</td>
            </tr>
          {% empty %}
            <tr><td colspan="13" class="left">No ledger entries found.</td></tr>
          {% endfor %}
          <tr class="total-row">
            <td colspan="5" class="left">TOTAL</td>
            <td>₦ {{ grand_total_principal|floatformat:2|intcomma }}</td>
            <td>₦ {{ grand_total_interest|floatformat:2|intcomma }}</td>
            <td>₦ {{ grand_total_penalty|floatformat:2|intcomma }}</td>
            <td>₦ {{ total_paid_sum|floatformat:2|intcomma }}</td>
            <td>{% if ledger_card %}₦ {{ final_principal_balance|floatformat:2|intcomma }}{% else %}--{% endif %}</td>
            <td>{% if ledger_card %}₦ {{ final_interest_balance|floatformat:2|intcomma }}{% else %}--{% endif %}</td>
            <td>{% if ledger_card %}₦ {{ final_penalty_balance|floatformat:2|intcomma }}{% else %}--{% endif %}</td>
            <td>₦ {{ final_total_balance|floatformat:2|intcomma }}</td>
          </tr>
        </tbody>
      </table>
    </div>
  {% endif %}
</div>
{% endblock %}
